VERSION 5.00
Object = "{92096210-97DF-11CF-9F27-02608C4BF3B5}#1.0#0"; "oradc.ocx"
Object = "{F9043C88-F6F2-101A-A3C9-08002B2F49FB}#1.2#0"; "COMDLG32.OCX"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.0#0"; "MSCOMCTL.OCX"
Object = "{B02F3647-766B-11CE-AF28-C3A2FBE76A13}#3.0#0"; "SPR32X30.ocx"
Begin VB.Form frmFurikaeYoteiImport 
   Caption         =   "êUë÷ó\íËï\ åì âñÒí ímèë(éÊçû)"
   ClientHeight    =   7515
   ClientLeft      =   1125
   ClientTop       =   2400
   ClientWidth     =   11175
   LinkTopic       =   "Form1"
   LockControls    =   -1  'True
   MaxButton       =   0   'False
   MinButton       =   0   'False
   ScaleHeight     =   7515
   ScaleWidth      =   11175
   Begin VB.Frame fraDetailInfo 
      Caption         =   "ñæç◊èWåvèÓïÒ"
      Height          =   1155
      Left            =   9120
      TabIndex        =   18
      Top             =   5160
      Width           =   1935
      Begin VB.Label Label2 
         Alignment       =   1  'âEëµÇ¶
         Caption         =   "ïœçXåèêîÅF"
         Height          =   195
         Left            =   120
         TabIndex        =   24
         Top             =   240
         Width           =   855
      End
      Begin VB.Label Label3 
         Alignment       =   1  'âEëµÇ¶
         Caption         =   "ã‡äzçáåvÅF"
         Height          =   195
         Left            =   120
         TabIndex        =   23
         Top             =   540
         Width           =   855
      End
      Begin VB.Label Label7 
         Alignment       =   1  'âEëµÇ¶
         Caption         =   "âñÒåèêîÅF"
         Height          =   195
         Left            =   120
         TabIndex        =   22
         Top             =   840
         Width           =   855
      End
      Begin VB.Label lblDetailCancel 
         Alignment       =   1  'âEëµÇ¶
         Caption         =   "123,456"
         BeginProperty Font 
            Name            =   "ÇlÇr Çoñæí©"
            Size            =   9
            Charset         =   128
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   195
         Left            =   960
         TabIndex        =   21
         Top             =   840
         Width           =   855
      End
      Begin VB.Label lblDetailCount 
         Alignment       =   1  'âEëµÇ¶
         Caption         =   "123,456"
         BeginProperty Font 
            Name            =   "ÇlÇr Çoñæí©"
            Size            =   9
            Charset         =   128
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   195
         Left            =   960
         TabIndex        =   20
         Top             =   240
         Width           =   855
      End
      Begin VB.Label lblDetailKingaku 
         Alignment       =   1  'âEëµÇ¶
         Caption         =   "123,456"
         BeginProperty Font 
            Name            =   "ÇlÇr Çoñæí©"
            Size            =   9
            Charset         =   128
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   195
         Left            =   960
         TabIndex        =   19
         Top             =   540
         Width           =   855
      End
   End
   Begin VB.CommandButton cmdSprUpdate 
      Caption         =   "çXêV(&S)"
      Height          =   435
      Left            =   9300
      TabIndex        =   5
      Top             =   3600
      Width           =   1095
   End
   Begin VB.ComboBox cboFIITKB 
      BackColor       =   &H000000FF&
      Height          =   300
      ItemData        =   "êUë÷ó\íËï\éÊçû.frx":0000
      Left            =   6240
      List            =   "êUë÷ó\íËï\éÊçû.frx":000D
      Style           =   2  'ƒﬁ€ØÃﬂ¿ﬁ≥› ÿΩƒ
      TabIndex        =   17
      Top             =   60
      Visible         =   0   'False
      Width           =   1215
   End
   Begin VB.CommandButton cmdCheck 
      Caption         =   "É`ÉFÉbÉN(&C)"
      Height          =   435
      Left            =   2040
      TabIndex        =   7
      Top             =   6540
      Width           =   1395
   End
   Begin VB.CommandButton cmdErrList 
      Caption         =   "ÉGÉâÅ[ÉäÉXÉg(&P)"
      Height          =   435
      Left            =   3540
      TabIndex        =   8
      Top             =   6540
      Width           =   1395
   End
   Begin VB.CommandButton cmdUpdate 
      Caption         =   "É}ÉXÉ^îΩâf(&U)"
      Height          =   435
      Left            =   7980
      TabIndex        =   10
      Top             =   6540
      Width           =   1395
   End
   Begin VB.CommandButton cmdDelete 
      Caption         =   "îpä¸(&D)"
      Height          =   435
      Left            =   6480
      TabIndex        =   9
      Top             =   6540
      Width           =   1395
   End
   Begin VB.ComboBox cboImpDate 
      Height          =   300
      Left            =   1200
      Style           =   2  'ƒﬁ€ØÃﬂ¿ﬁ≥› ÿΩƒ
      TabIndex        =   1
      Top             =   60
      Width           =   1935
   End
   Begin VB.ComboBox cboSort 
      Height          =   300
      ItemData        =   "êUë÷ó\íËï\éÊçû.frx":0037
      Left            =   4500
      List            =   "êUë÷ó\íËï\éÊçû.frx":0041
      Style           =   2  'ƒﬁ€ØÃﬂ¿ﬁ≥› ÿΩƒ
      TabIndex        =   2
      Top             =   60
      Width           =   1335
   End
   Begin VB.Frame fraProgressBar 
      BackColor       =   &H00FF0000&
      BorderStyle     =   0  'Ç»Çµ
      Caption         =   "fraProgressBar"
      ForeColor       =   &H80000004&
      Height          =   290
      Left            =   1980
      TabIndex        =   13
      Top             =   7140
      Width           =   7060
      Begin MSComctlLib.ProgressBar pgrProgressBar 
         Height          =   255
         Left            =   15
         TabIndex        =   14
         Top             =   15
         Width           =   7035
         _ExtentX        =   12409
         _ExtentY        =   450
         _Version        =   393216
         Appearance      =   0
         Enabled         =   0   'False
      End
   End
   Begin VB.CommandButton cmdImport 
      Caption         =   "éÊçû(&I)"
      Height          =   435
      Left            =   420
      TabIndex        =   6
      Top             =   6540
      Width           =   1395
   End
   Begin VB.CommandButton cmdEnd 
      Caption         =   "èIóπ(&X)"
      Height          =   435
      Left            =   9600
      TabIndex        =   0
      Top             =   6540
      Width           =   1335
   End
   Begin MSComctlLib.StatusBar stbStatus 
      Align           =   2  'â∫ëµÇ¶
      Height          =   315
      Left            =   0
      TabIndex        =   12
      Top             =   7200
      Width           =   11175
      _ExtentX        =   19711
      _ExtentY        =   556
      _Version        =   393216
      BeginProperty Panels {8E3867A5-8586-11D1-B16A-00C0F0283628} 
         NumPanels       =   1
         BeginProperty Panel1 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Object.Width           =   3175
            MinWidth        =   3175
            Text            =   "écÇË 9,999 åè"
            TextSave        =   "écÇË 9,999 åè"
         EndProperty
      EndProperty
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "ÇlÇr Çoñæí©"
         Size            =   9
         Charset         =   128
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
   End
   Begin MSComDlg.CommonDialog dlgFile 
      Left            =   10560
      Top             =   3540
      _ExtentX        =   847
      _ExtentY        =   847
      _Version        =   393216
   End
   Begin ORADCLibCtl.ORADC dbcImportTotal 
      Height          =   315
      Left            =   9180
      Top             =   4080
      Visible         =   0   'False
      Width           =   2415
      _Version        =   65536
      _ExtentX        =   4260
      _ExtentY        =   556
      _StockProps     =   207
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "ÇlÇr ÇoÉSÉVÉbÉN"
         Size            =   9
         Charset         =   128
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      DatabaseName    =   "dcssvr03"
      Connect         =   "kumon/kumon"
      RecordSource    =   "select * from tfFurikaeYoteiImport Where firkbn=1"
   End
   Begin ORADCLibCtl.ORADC dbcImportDetail 
      Height          =   315
      Left            =   9180
      Top             =   4440
      Visible         =   0   'False
      Width           =   2415
      _Version        =   65536
      _ExtentX        =   4260
      _ExtentY        =   556
      _StockProps     =   207
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "ÇlÇr ÇoÉSÉVÉbÉN"
         Size            =   9
         Charset         =   128
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      DatabaseName    =   "dcssvr03"
      Connect         =   "kumon/kumon"
      RecordSource    =   "select * from tfFurikaeYoteiImport Where firkbn=0"
   End
   Begin FPSpread.vaSpread sprTotal 
      Bindings        =   "êUë÷ó\íËï\éÊçû.frx":0057
      Height          =   2865
      Left            =   420
      TabIndex        =   3
      Top             =   480
      Width           =   10140
      _Version        =   196608
      _ExtentX        =   17886
      _ExtentY        =   5054
      _StockProps     =   64
      ButtonDrawMode  =   4
      DAutoCellTypes  =   0   'False
      DAutoHeadings   =   0   'False
      DAutoSave       =   0   'False
      DAutoSizeCols   =   0
      EditModeReplace =   -1  'True
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "ÇlÇr Çoñæí©"
         Size            =   9.75
         Charset         =   128
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      MaxCols         =   17
      MaxRows         =   12
      ScrollBars      =   2
      SpreadDesigner  =   "êUë÷ó\íËï\éÊçû.frx":0074
      UserResize      =   0
      VScrollSpecial  =   -1  'True
   End
   Begin FPSpread.vaSpread sprDetail 
      Bindings        =   "êUë÷ó\íËï\éÊçû.frx":07C0
      Height          =   2895
      Left            =   420
      TabIndex        =   4
      Top             =   3420
      Width           =   8610
      _Version        =   196608
      _ExtentX        =   15187
      _ExtentY        =   5106
      _StockProps     =   64
      ButtonDrawMode  =   4
      DAutoCellTypes  =   0   'False
      DAutoHeadings   =   0   'False
      DAutoSave       =   0   'False
      DAutoSizeCols   =   0
      EditModeReplace =   -1  'True
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "ÇlÇr Çoñæí©"
         Size            =   9.75
         Charset         =   128
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      MaxCols         =   18
      MaxRows         =   15
      ScrollBars      =   2
      SpreadDesigner  =   "êUë÷ó\íËï\éÊçû.frx":07DE
      UserResize      =   0
      VirtualScrollBuffer=   -1  'True
      VScrollSpecial  =   -1  'True
   End
   Begin VB.Label Label8 
      Caption         =   "éÊçûì˙éû"
      Height          =   180
      Left            =   360
      TabIndex        =   16
      Top             =   120
      Width           =   780
   End
   Begin VB.Label Label1 
      Caption         =   "ï\é¶èá"
      Height          =   180
      Left            =   3780
      TabIndex        =   15
      Top             =   120
      Width           =   600
   End
   Begin VB.Label lblSysDate 
      Caption         =   "Label26"
      Height          =   255
      Left            =   8460
      TabIndex        =   11
      Top             =   0
      Width           =   1395
   End
   Begin VB.Menu mnuFile 
      Caption         =   "Ãß≤Ÿ(&F)"
      Begin VB.Menu mnuEnd 
         Caption         =   "èIóπ(&X)"
      End
   End
   Begin VB.Menu mnuHelp 
      Caption         =   "ÕŸÃﬂ(&H)"
      Begin VB.Menu mnuVersion 
         Caption         =   " ﬁ∞ºﬁÆ›èÓïÒ(&A)"
      End
   End
   Begin VB.Menu mnuSpread 
      Caption         =   "ÉXÉvÉåÉbÉhï“èW(&S)"
      Enabled         =   0   'False
      Visible         =   0   'False
      Begin VB.Menu mnuTitle 
         Caption         =   "É^ÉCÉgÉã"
      End
      Begin VB.Menu mnuSprDelete 
         Caption         =   "ñæç◊ÇÃçÌèú(&D)"
      End
      Begin VB.Menu mnuSprReset 
         Caption         =   "ñæç◊ÇÃçÌèúÇâèú(&R)"
      End
   End
End
Attribute VB_Name = "frmFurikaeYoteiImport"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
#If NO_RELEASE Then
Option Explicit

#Const DETAIL_SEQN_ORDER = True         '//ñæç◊ÇÕÇrÇdÇpèáÇ…ÅFéÜÇ∆ÇÃìÀçáÇπÇ™ÇµÇ…Ç≠Ç¢ÅI
#Const BLOCK_CHECK = False              '//É`ÉFÉbÉNéûÇÃÉuÉçÉbÉNÇ™Ç¢Ç≠Ç¬Ç†ÇÈÇ©ÅHÇï\é¶ÅFÉfÉoÉbÉNéûÇÃÇ›
#If BLOCK_CHECK = True Then             '//É`ÉFÉbÉNéûÇÃÉuÉçÉbÉNÇ™Ç¢Ç≠Ç¬Ç†ÇÈÇ©ÅHÇï\é¶ÅFÉfÉoÉbÉNéûÇÃÇ›
Private mCheckBlocks As Integer
#End If

Private Type tpFurikaeTotal    '//çáåvÉåÉRÅ[Éh
    MochikomiBi As String * 8   '//éùÇøçûÇ›ì˙ 2006/03/24 çÄñ⁄í«â¡
    KeiyakuNo   As String * 5   '//å_ñÒé“î‘çÜ
    KyoshitsuNo As String * 3   '//ã≥é∫î‘çÜ
    PageNumber  As String * 2   '//ÉyÅ[ÉWî‘çÜ
    FurikaeDate As String * 8   '//êUë÷ì˙
    DetailCnt   As String * 2   '//ñæç◊åèêî
    DetailGaku  As String * 6   '//ñæç◊çáåvã‡äz
    CancelCnt   As String * 2   '//ñæç◊âñÒåèêî
    RecKubun    As String * 1   '//âñÒÉtÉâÉOÇó¨ópÅFÇPÅÅâñÒÅ^ÇXÅÅçáåv
    KouzaName   As String * 40  '//2006/04/26 å˚ç¿ñºã`êlñº
    CrLf        As String * 2  'CR + LF
End Type

Private Type tpFurikaeDetail   '//ñæç◊ÉåÉRÅ[Éh
    MochikomiBi As String * 8   '//éùÇøçûÇ›ì˙ 2006/03/24 çÄñ⁄í«â¡
    KeiyakuNo   As String * 5   '//å_ñÒé“î‘çÜ
    KyoshitsuNo As String * 3   '//ã≥é∫î‘çÜ
    PageNumber  As String * 2   '//ÉyÅ[ÉWî‘çÜ
    FurikaeDate As String * 8   '//êUë÷ì˙
    HogoshaNo   As String * 4   '//ï€åÏé“î‘çÜ
    HenkouGaku  As String * 6   '//ïœçXã‡äz
    CancelFlag  As String * 1   '//âñÒÉtÉâÉO
    KouzaName   As String * 40  '//2006/04/26 å˚ç¿ñºã`êlñº
    CrLf        As String * 2  'CR + LF
End Type

Private Enum eSprTotal
    eErrorStts = 1  '   FIERROR ÉGÉâÅ[ì‡óeÅFàŸèÌÅAê≥èÌÅAåxçê
    eMochikomiBi    '           éùçûì˙
    eImportCnt      '           éÊçûâÒêî
    eItakuName      '           àœëıé“ñº
    eKeiyakuCode    '   FIKYCD  å_ñÒé“
    eKeiyakuName    '           å_ñÒé“ñº
    eKyoshitsuNo    '   FIKSCD  ã≥é∫î‘çÜ
    ePageNumber     '   FIPGNO  ï≈
    eFirukaeDate    '   FIFKDT  êUë÷ì˙
    eHenkoCount     '   FIHKCT  ïœçXåèêî
    eHenkoKingaku   '   FIHKCT  ïœçXã‡äz
    eCancelCount    '   FIKYCT  âñÒåèêî
    '//ï\é¶Ç∑ÇÈóÒÇÕçüèàÇ‹Ç≈
    eUseCols
    eImpDate = eUseCols 'FIINDT
    eImpSEQ         '   FISEQN
    eItakuCode      '   FIITKB  àœëıé“
    eErrorFlag      '//èCê≥éûÇ… FIERROR Ç…çXêVÇ∑ÇÈà◊Ç…ê›íËÅFàÀóäèëÇ∆ÇÕé·ä±ìÆÇ´Ç™à·Ç§ÇÃÇ≈...ÅB
    eEditFlag       '//ïœçXÉtÉâÉO
    eMaxCols = 30   '//ÉGÉâÅ[óÒÇ‡ä‹ÇﬂÇƒÅI
End Enum
Private Enum eSprDetail
    eErrorStts = 1  '   FIERROR ÉGÉâÅ[ì‡óeÅFàŸèÌÅAê≥èÌÅAåxçê
    eMochikomiBi    '           éùçûì˙
    eImportCnt      '           éÊçûâÒêî
    eHogoshaNo      '   FIHGCD  ï€åÏé“î‘çÜ
    eMasterKouza
    eImportKouza    '   FIKZNM  å˚ç¿ñºã`êlñº
    eHenkoGaku      '   FIHKKG  ïœçXã‡äz
    eCancelFlag     '   FIKYFG  âñÒÉtÉâÉO
    '//ï\é¶Ç∑ÇÈóÒÇÕçüèàÇ‹Ç≈
    eUseCols
    eImpDate = eUseCols 'FIINDT
    eImpSEQ         '   FISEQN
    eItakuCode      '   FIITKB  àœëıé“
    eKeiyakuCode    '   FIKYCD  å_ñÒé“
    eKyoshitsuNo    '   FIKSCD  ã≥é∫î‘çÜ
    ePageNumber     '   FIPGNO  ï≈
    eFirukaeDate    '   FIFKDT  êUë÷ì˙
    eErrorFlag      '//èCê≥éûÇ… FIERROR Ç…çXêVÇ∑ÇÈà◊Ç…ê›íËÅFàÀóäèëÇ∆ÇÕé·ä±ìÆÇ´Ç™à·Ç§ÇÃÇ≈...ÅB
    eEditFlag       '//ïœçXÉtÉâÉO
    eMaxCols = 30   '//ÉGÉâÅ[óÒÇ‡ä‹ÇﬂÇƒÅI
End Enum
Private mCaption    As String
Private mAbort      As Boolean
Private mForm       As New FormClass
Private mReg        As New RegistryClass
Private mYimp       As New FurikaeSchImpClass
Private mSprTotal   As New SpreadClass
Private mSprDetail  As New SpreadClass
Private mLeaveCellEvents As Boolean     '//ãNìÆéûÇÃÇPâÒñ⁄ÇÃÇ› LeaveCell ÉCÉxÉìÉgÇ™î≠ê∂ÇµÇ»Ç¢ÇÃÇ≈êßå‰

Private Const cBtnCancel As String = "íÜé~(&A)"
Private Const cBtnImport As String = "éÊçû(&I)"
Private Const cBtnDelete As String = "îpä¸(&D)"
Private Const cBtnCheck  As String = "É`ÉFÉbÉN(&C)"
Private Const cBtnUpdate As String = "É}ÉXÉ^îΩâf(&U)"
Private Const cBtnSprUpdate As String = "çXêV(&S)"
Private Const cImportToYotei  As String = "Y"   '//ó\íËîΩâf
Private Const cImportToDelete As String = "D"   '//îpä¸
Private Const cEditDataMsg  As String = "èCê≥ => É`ÉFÉbÉNèàóùÇÇµÇƒâ∫Ç≥Ç¢ÅB"
Private Const cImportMsg    As String = "éÊçû => É`ÉFÉbÉNèàóùÇÇµÇƒâ∫Ç≥Ç¢ÅB"
Private Const cDeleteMsg    As String = "çÌèú => âèúÇ™â¬î\Ç≈Ç∑ÅB"
Private Const cVisibleRows  As Long = 12
Private Const cInSQLString = "FIINDT,FIITKB,FIKYCD,FIKSCD,FIPGNO"
'//2006/06/16 å_ñÒé“î‘çÜñ≥ÇµÇÃÉpÉìÉ`ÉfÅ[É^ëŒâû
Private Const cFIKYCD_BadStart As Long = 90001  '//å_ñÒé“ÉpÉìÉ`ñ≥ÇµÇÃäJénî‘çÜ
Private Const cFIITKB_BadCode As String = "Z"
'//ñæç◊çÌèúÇÃïœêîê›íË
Private mDeleteSeqNo As Long        '//çÌèúëŒè€ÇrÇdÇp-ÇmÇè

Private mDeleteMenu As Integer      '//çÌèúÉAÉNÉVÉáÉìÇÃÉÅÉjÉÖÅ[ -1=Delete,0=NonMenu,1=Reset
Private Enum ePopup
    eDelete = -1
    eNoMenu
    eReset
End Enum

'//ÇrÇpÇkåãâ ÉZÉbÉgÇÃÉIÅ[É_Å[ãÂ ÅÅÅÑ èCê≥ÅAÉGÉâÅ[ÅAåxçêÅAê≥èÌÇÃèá
'//2006/04/14 ORDER Ç™évòfí ÇËÇ…Ç»Ç¡ÇƒÇ¢Ç»Ç©Ç¡ÇΩ
'//2006/06/16 ñæç◊çÌèú -4 ÇÃëŒâû
Private Const cSQLOrderString = " DECODE(FIERROR,-4,-13,-2, -11, -1,-12, 1,-10 ,FIERROR) "

Private Enum eSort
    eImportSeq
    eKeiyakusha
'    eKinnyuKikan
End Enum

Private Sub cboImpDate_Click()
    If "" = Trim(cboImpDate.Text) Then
        '//óLÇËìæÇ»Ç¢
        Exit Sub
    End If
    If True = pSpreadCheckAndUpdate(sprTotal.Tag = mSprTotal.RowEdit Or sprDetail.Tag = mSprDetail.RowEdit) Then
        Exit Sub
    End If
    Dim ms As New MouseClass
    Call ms.Start
    '//ÉfÅ[É^ì«Ç›çûÇ›Åï Spread Ç…ê›íËîΩâf
    Call pReadTotalDataAndSetting
End Sub

Private Sub cboSort_Click()
    Call cboImpDate_Click
End Sub

Private Function pMoveTempRecords(vCondition As String, vMode As String) As Long
    Dim sql As String
    '//çÌèúëŒè€ÉfÅ[É^Ç Temp Ç…ÉoÉbÉNÉAÉbÉv
    sql = "INSERT INTO " & mYimp.TfFurikaeImport & "Temp" & vbCrLf
    sql = sql & " SELECT SYSDATE,'" & vMode & "',a.*"
    sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
    sql = sql & " WHERE 1 = 1" & vbCrLf
    sql = sql & vCondition
    Call gdDBS.Database.ExecuteSQL(sql)
    
    sql = "DELETE " & mYimp.TfFurikaeImport & " a " & vbCrLf
    sql = sql & " WHERE 1 = 1" & vbCrLf
    sql = sql & vCondition
    pMoveTempRecords = gdDBS.Database.ExecuteSQL(sql)
End Function

Private Function pProgressBarSet(ByRef rBlockStep As Integer, Optional ByRef rStepCnt As Long = -1) As Boolean
    DoEvents    '//ÉCÉxÉìÉgéÛït
    If mAbort Then
        pProgressBarSet = False     '//èàóùíÜífÅI
        Exit Function
    End If
    '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
    If 0 <= rStepCnt Then
        If 0 = rStepCnt Then
            rBlockStep = rBlockStep - 1
        End If
        rStepCnt = rStepCnt + 1
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "écÇË(" & rBlockStep & ") - " & pgrProgressBar.Max - rStepCnt
        pgrProgressBar.Value = IIf(rStepCnt < pgrProgressBar.Max, rStepCnt, pgrProgressBar.Max)
    Else
        rBlockStep = rBlockStep - 1
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "écÇË(" & rBlockStep & ")"
        pgrProgressBar.Value = IIf(0 <= pgrProgressBar.Max - rBlockStep, pgrProgressBar.Max - rBlockStep, pgrProgressBar.Max)
    End If
    pProgressBarSet = True
#If BLOCK_CHECK = True Then           '//É`ÉFÉbÉNéûÇÃÉuÉçÉbÉNÇ™Ç¢Ç≠Ç¬Ç†ÇÈÇ©ÅHÇï\é¶ÅFÉfÉoÉbÉNéûÇÃÇ›
    If rStepCnt <= 1 Then
        mCheckBlocks = mCheckBlocks + 1
    End If
#End If
End Function

Private Function pDataCheck(vImpDate As Variant) As Boolean
    Dim sqlStep As Long, Block As Integer, recCnt As Long
    
    Const cMaxBlock As Integer = 16
    Block = cMaxBlock
#If BLOCK_CHECK = True Then           '//É`ÉFÉbÉNéûÇÃÉuÉçÉbÉNÇ™Ç¢Ç≠Ç¬Ç†ÇÈÇ©ÅHÇï\é¶ÅFÉfÉoÉbÉNéûÇÃÇ›
    mCheckBlocks = 0
#End If
    '// WHERE ãÂÇ…ÇÕïKÇ∏ïtâ¡
    Dim SameConditions As String
    SameConditions = " AND FIINDT = TO_DATE('" & vImpDate & "','yyyy/mm/dd hh24:mi:ss')"
'//2006/06/16 ñæç◊çÌèúëŒâû
    SameConditions = SameConditions & " AND FIERROR <> " & mYimp.errDeleted
    
    On Error GoTo gDataCheckError:
    
    Call gdDBS.AutoLogOut(mCaption, "[" & vImpDate & "] ÇÃÉ`ÉFÉbÉNèàóùÇ™äJénÇ≥ÇÍÇ‹ÇµÇΩÅB")
    
    Call gdDBS.Database.BeginTrans          '//ÉgÉâÉìÉUÉNÉVÉáÉìäJén
    Dim sql As String
    
    fraProgressBar.Visible = True
    pgrProgressBar.Max = cMaxBlock
    '//////////////////////////////////////////////////
    '//ÉGÉâÅ[çÄñ⁄ÉäÉZÉbÉg
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    '//êUë÷ó\íËï\ÇÕçüèàÇ≈ÉNÉäÉAÇµÇ»Ç¢Ç∆âΩèàÇ≈Ç‡èoóàÇ»Ç¢
    sql = sql & " FIOKFG = " & mYimp.errNormal & "," & vbCrLf
    sql = sql & mYimp.StatusColumns(" = " & mYimp.errNormal & "," & vbCrLf)
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE 1 = 1" & vbCrLf  '//Ç®Ç‹Ç∂Ç»Ç¢
    sql = sql & SameConditions & vbCrLf
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//////////////////////////////////////////////////
    '//å_ñÒé“ÉRÅ[ÉhÅFàœëıé“ÉRÅ[ÉhÇåàíËÇ∑ÇÈà◊Ç…êÊÇ…É`ÉFÉbÉNÇ∑ÇÈ
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIKYCDE = DECODE(LENGTH(FIKYCD),5," & mYimp.errNormal & "," & mYimp.errInvalid & ")," & vbCrLf   '//ÇTåÖÇ≈Ç»ÇØÇÍÇŒÉGÉâÅ[
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE FIKYCDE = " & mYimp.errNormal & vbCrLf
    sql = sql & SameConditions & vbCrLf
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//////////////////////////////////////////////////
    '//àœëıé“ãÊï™
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIITKBE = (SELECT DECODE(COUNT(*),0," & mYimp.errInvalid & "," & mYimp.errNormal & ") " & vbCrLf
    sql = sql & "            FROM taItakushaMaster " & vbCrLf
    sql = sql & "            WHERE ABKYTP = SUBSTRB(a.FIKYCD,1,1)" & vbCrLf
    sql = sql & "            )," & vbCrLf
    sql = sql & " FIITKB  = (SELECT ABITKB "
    sql = sql & "            FROM taItakushaMaster " & vbCrLf
    sql = sql & "            WHERE ABKYTP = SUBSTRB(a.FIKYCD,1,1)" & vbCrLf
    sql = sql & "            )," & vbCrLf
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE FIITKBE = " & mYimp.errNormal & vbCrLf
    sql = sql & "   AND FIKYCDE = " & mYimp.errNormal & vbCrLf    '//è„Ç≈ÇÃå_ñÒé“ÉRÅ[ÉhÉGÉâÅ[ÇÕïsóv
    sql = sql & "   AND FIITKB IS NULL" & vbCrLf        '//ä˘Ç…àœëıé“ãÊï™Ç™ì¸óÕÇ≥ÇÍÇƒÇ¢ÇÍÇŒçXêVÇµÇ»Ç¢
    sql = sql & SameConditions & vbCrLf
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//////////////////////////////////////////////////
    '//å_ñÒé“ÉRÅ[ÉhÅFçXÇ…çƒìxÅAàœëıé“îzâ∫ÇÃå_ñÒé“ÇÉ`ÉFÉbÉN
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIKYCDE = (SELECT DECODE(COUNT(*),0," & mYimp.errInvalid & "," & mYimp.errNormal & ") " & vbCrLf
    sql = sql & "            FROM tbKeiyakushaMaster " & vbCrLf
    sql = sql & "            WHERE BAITKB = a.FIITKB " & vbCrLf
    sql = sql & "              AND BAKYCD = a.FIKYCD " & vbCrLf
    sql = sql & "              AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN BAKYST AND BAKYED " & vbCrLf '//å_ñÒä˙ä‘
    sql = sql & "              AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN BAFKST AND BAFKED " & vbCrLf '//êUë÷ä˙ä‘
    sql = sql & "         )," & vbCrLf
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE FIKYCD IS NOT NULL " & vbCrLf
    sql = sql & SameConditions & vbCrLf
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//ã≥é∫î‘çÜ
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    '//JOINÇ≈égópÇµÇ»Ç¢ÇÃÇ≈ã≥é∫î‘çÜÇ™ì¸óÕÇ≥ÇÍÇƒÇ¢ÇÈÇÃÇ›ÇîªífÇ≈â¬ÅI
#If 1 Then
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIKSCDE = DECODE(FIKSCD,NULL," & mYimp.errInvalid & "," & mYimp.errNormal & ")," & vbCrLf
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE FIKSCDE = " & mYimp.errNormal & vbCrLf
    sql = sql & SameConditions & vbCrLf
#Else
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIKSCDE = (SELECT DECODE(COUNT(*),0," & mYimp.errInvalid & "," & mYimp.errNormal & ") " & vbCrLf
    sql = sql & "            FROM tbKeiyakushaMaster " & vbCrLf
    sql = sql & "            WHERE BAITKB = a.FIITKB " & vbCrLf
    sql = sql & "              AND BAKYCD = a.FIKYCD " & vbCrLf
    sql = sql & "              AND BAKSCD = a.FIKSCD " & vbCrLf
    sql = sql & "              AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN BAKYST AND BAKYED " & vbCrLf '//å_ñÒä˙ä‘
    sql = sql & "              AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN BAFKST AND BAFKED " & vbCrLf '//êUë÷ä˙ä‘
    sql = sql & "            )," & vbCrLf
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE FIKSCDE = " & mYimp.errNormal & vbCrLf
    sql = sql & SameConditions & vbCrLf
#End If
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//////////////////////////////////////////////////
    '//ï€åÏé“ÉRÅ[ÉhÅFóLñ≥
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIHGCDE = " & mYimp.errInvalid & "," & vbCrLf
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE FIHGCD IS NULL" & vbCrLf
    sql = sql & "   AND FIHGCDE = " & mYimp.errNormal & vbCrLf
    sql = sql & "   AND FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & SameConditions & vbCrLf
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//////////////////////////////////////////////////
    '//ï€åÏé“ÉRÅ[ÉhÅFï€åÏé“É}ÉXÉ^
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIHGCDE = (SELECT DECODE(COUNT(*),0," & mYimp.errInvalid & "," & mYimp.errNormal & ") " & vbCrLf
    sql = sql & "            FROM tcHogoshaMaster " & vbCrLf
    sql = sql & "            WHERE CAITKB = a.FIITKB " & vbCrLf
    sql = sql & "              AND CAKYCD = a.FIKYCD " & vbCrLf
    sql = sql & "              AND CAKSCD = a.FIKSCD " & vbCrLf    '//2006/04/13 ã≥é∫í«â¡
    sql = sql & "              AND CAHGCD = a.FIHGCD " & vbCrLf
#If 0 Then  '//2006/04/05 ë∂ç›Ç∑ÇÍÇŒÉGÉâÅ[Ç…ÇµÇ»Ç¢
    '//ï€åÏé“ÇÕåªç›óLå¯ï™ÅFå_ñÒä˙ä‘ÅïêUë÷ä˙ä‘
'    sql = sql & "              AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN CAKYST AND CAKYED " & vbCrLf '//å_ñÒä˙ä‘
'    sql = sql & "              AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN CAFKST AND CAFKED " & vbCrLf '//êUë÷ä˙ä‘
#End If
    sql = sql & "            )," & vbCrLf
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE FIHGCDE = " & mYimp.errNormal & vbCrLf
    sql = sql & "   AND FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & SameConditions & vbCrLf
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//////////////////////////////////////////////////
    '//å˚ç¿ñºã`êlñºÅFï€åÏé“É}ÉXÉ^
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIKZNME = (SELECT " & vbCrLf
    sql = sql & "             CASE WHEN REPLACE(FIKZNM,' ',NULL) = REPLACE(CAKZNM,' ',NULL) THEN " & mYimp.errNormal & vbCrLf
    sql = sql & "                  ELSE                                                          " & mYimp.errInvalid & vbCrLf
    sql = sql & "             END " & vbCrLf
    sql = sql & "            FROM tcHogoshaMaster " & vbCrLf
    sql = sql & "            WHERE    (CAITKB,CAKYCD,CAKSCD,CAHGCD,    CASQNO) IN (" & vbCrLf
    sql = sql & "               SELECT CAITKB,CAKYCD,CAKSCD,CAHGCD,MAX(CASQNO)" & vbCrLf
    sql = sql & "               FROM tcHogoshaMaster " & vbCrLf
    sql = sql & "               WHERE CAITKB = a.FIITKB " & vbCrLf
    sql = sql & "                 AND CAKYCD = a.FIKYCD " & vbCrLf
    sql = sql & "                 AND CAKSCD = a.FIKSCD " & vbCrLf    '//2006/04/13 ã≥é∫í«â¡
    sql = sql & "                 AND CAHGCD = a.FIHGCD " & vbCrLf
    sql = sql & "               GROUP BY CAITKB,CAKYCD,CAKSCD,CAHGCD" & vbCrLf
    sql = sql & "               )" & vbCrLf
    sql = sql & "              AND CAITKB = a.FIITKB " & vbCrLf
    sql = sql & "              AND CAKYCD = a.FIKYCD " & vbCrLf
    sql = sql & "              AND CAKSCD = a.FIKSCD " & vbCrLf    '//2006/04/13 ã≥é∫í«â¡
    sql = sql & "              AND CAHGCD = a.FIHGCD " & vbCrLf
#If 0 Then  '//2006/04/05 ë∂ç›Ç∑ÇÍÇŒÉGÉâÅ[Ç…ÇµÇ»Ç¢
    '//ï€åÏé“ÇÕåªç›óLå¯ï™ÅFå_ñÒä˙ä‘ÅïêUë÷ä˙ä‘
'    sql = sql & "              AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN CAKYST AND CAKYED " & vbCrLf '//å_ñÒä˙ä‘
'    sql = sql & "              AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN CAFKST AND CAFKED " & vbCrLf '//êUë÷ä˙ä‘
#End If
    sql = sql & "            )," & vbCrLf
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE FIHGCDE = " & mYimp.errNormal & vbCrLf
    sql = sql & "   AND FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & SameConditions & vbCrLf
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//////////////////////////////////////////////////
    '//ï€åÏé“ÉRÅ[ÉhÅFêUë÷ó\íËÉfÅ[É^
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIFKDTE = (SELECT DECODE(COUNT(*),0," & mYimp.errInvalid & "," & mYimp.errNormal & ") " & vbCrLf
    sql = sql & "            FROM tfFurikaeYoteiData " & vbCrLf
    sql = sql & "            WHERE FAITKB = a.FIITKB " & vbCrLf
    sql = sql & "              AND FAKYCD = a.FIKYCD " & vbCrLf
    sql = sql & "              AND FAHGCD = a.FIHGCD " & vbCrLf
    sql = sql & "              AND FASQNO = a.FIFKDT " & vbCrLf
    sql = sql & "            )," & vbCrLf
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE FIFKDTE = " & mYimp.errNormal & vbCrLf
    sql = sql & "   AND FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & SameConditions & vbCrLf
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//////////////////////////////////////////////////
    '//ï€åÏé“ÉRÅ[ÉhÅFêUë÷ó\íËÉfÅ[É^ÅFçáåvÇ÷ÇÃì]ãL
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIFKDTE = (SELECT DECODE(COUNT(*),0," & mYimp.errNormal & "," & mYimp.errWarning & ") " & vbCrLf
    sql = sql & "            FROM " & mYimp.TfFurikaeImport & " b " & vbCrLf
    sql = sql & "            WHERE a.FIINDT = b.FIINDT " & vbCrLf
    sql = sql & "              AND a.FISEQN = b.FIRKBN " & vbCrLf
    sql = sql & "              AND b.FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & "              AND b.FIFKDTE <> " & mYimp.errNormal & vbCrLf
    sql = sql & "            )," & vbCrLf
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE FIFKDTE = " & mYimp.errNormal & vbCrLf
    sql = sql & "   AND FIRKBN  = " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & SameConditions & vbCrLf
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//////////////////////////////////////////////////
    '//âñÒÅïã‡äzóLÇËÇÃÉ`ÉFÉbÉN
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIHKKGE = " & mYimp.errWarning & "," & vbCrLf
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE FIHKKGE = " & mYimp.errNormal & vbCrLf
    '//2006/04/05 âñÒÇ≈ã‡äzÇ™óLÇËÅFåxçê
    sql = sql & "   AND ( NVL(FIKYFG,0) <> 0 AND NVL(FIHKKG,0) <> 0" & vbCrLf
    '//2006/04/05 âñÒÇ≈ñ≥Ç≠ã‡äzÇ™Ç»ÇµÅFåxçê
    '//2006/04/13 ã‡äzÅuÇOÅvÇ≈âñÒÇ≈ñ≥Ç¢ÉfÅ[É^óLÇË
    'sql = sql & "      OR NVL(FIKYFG,0) =  0 AND NVL(FIHKKG,0)  = 0" & vbCrLf
    sql = sql & "   ) " & vbCrLf
    sql = sql & "   AND FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & SameConditions & vbCrLf
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//////////////////////////////////////////////////
    '//ñæç◊çsÅïçáåvçs ä‘ÇÃÉ`ÉFÉbÉN
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
#If ORA_DEBUG = 1 Then
    Dim dynM As OraDynaset, dynS As OraDynaset, hkctErr As Boolean, hkkgErr As Boolean, kyctErr As Boolean
#Else
    Dim dynM As Object, dynS As Object, hkctErr As Boolean, hkkgErr As Boolean, kyctErr As Boolean
#End If
    '//çáåvÉåÉRÅ[ÉhÇÃéÊìæ
    sql = "SELECT * FROM " & mYimp.TfFurikaeImport & vbCrLf
    sql = sql & " WHERE FIRKBN = " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & SameConditions & vbCrLf
    sql = sql & " ORDER BY FIITKB,FIKYCD,FIKSCD" & vbCrLf
#If ORA_DEBUG = 1 Then
    Set dynM = gdDBS.OpenRecordset(sql, dynOption.ORADYN_READONLY)
#Else
    Set dynM = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
#End If
    sqlStep = 0
    If Not dynM.EOF Then
        pgrProgressBar.Value = 0
        pgrProgressBar.Max = dynM.RecordCount
    End If
    Do Until dynM.EOF
        '//////////////////////////////////////////////////
        '// DoEvents ÇÕ pProgressBarSet() ÇÃíÜÇ≈é¿çsÇ≥ÇÍÇƒÇ¢ÇÈ
        If False = pProgressBarSet(Block, sqlStep) Then
            GoTo gDataCheckError:
        End If
        '//ñæç◊çsÇÃçáåvÇéÊìæ
        '//ÉåÉXÉ|ÉìÉXÇÕíxÇ¢Ç©Ç‡ÅH
        sql = "SELECT " & vbCrLf
        '//ïœçXåèêîÇ…ÇÕâñÒÇä‹Ç‹Ç»Ç¢
        'sql = sql & " COUNT(*) FIHKCT,"& vbCrLf
        '//2006/04/14 ã‡äzÅuÇOÅvÇ≈âñÒñ≥ÇµÇ™Ç†ÇÈ
        sql = sql & " SUM(DECODE(NVL(FIKYFG,0),0,1,0)) FIHKCT," & vbCrLf
        sql = sql & " SUM(       NVL(FIHKKG,0)       ) FIHKKG," & vbCrLf
        sql = sql & " SUM(DECODE(NVL(FIKYFG,0),0,0,1)) FIKYCT " & vbCrLf
        sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
        sql = sql & " WHERE       (" & cInSQLString & ") IN(" & vbCrLf
        sql = sql & "       SELECT " & cInSQLString & vbCrLf
        sql = sql & "       FROM " & mYimp.TfFurikaeImport & " b " & vbCrLf
        sql = sql & "       WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(dynM.Fields("FIINDT"), "D", vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss')" & vbCrLf
        sql = sql & "         AND FISEQN = " & gdDBS.ColumnDataSet(dynM.Fields("FISEQN"), "L", vEnd:=True) & vbCrLf
        sql = sql & "         AND FIRKBN = " & mYimp.RecordIsTotal & vbCrLf
        sql = sql & "       )"
'z 2006/06/13 èdï°ÉfÅ[É^éûÇÃèCê≥
'z        sql = sql & "   AND FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf
        sql = sql & "   AND FISEQN <> " & gdDBS.ColumnDataSet(dynM.Fields("FISEQN"), "L", vEnd:=True) & vbCrLf
#If ORA_DEBUG = 1 Then
        Set dynS = gdDBS.OpenRecordset(sql, dynOption.ORADYN_READONLY)
#Else
        Set dynS = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
#End If
        '//2006/04/13 Null ÉGÉâÅ[âÒî:gdDBS.Nz()í«â¡
        hkctErr = gdDBS.Nz(dynM.Fields("FIHKCT")) <> gdDBS.Nz(dynS.Fields("FIHKCT"))
        hkkgErr = gdDBS.Nz(dynM.Fields("FIHKKG")) <> gdDBS.Nz(dynS.Fields("FIHKKG"))
        kyctErr = gdDBS.Nz(dynM.Fields("FIKYCT")) <> gdDBS.Nz(dynS.Fields("FIKYCT"))
        '//çáåvçsÇ…çXêV
        sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
        sql = sql & " FIHKCTE = " & IIf(hkctErr, mYimp.errWarning, mYimp.errNormal) & "," & vbCrLf
        sql = sql & " FIHKKGE = " & IIf(hkkgErr, mYimp.errWarning, mYimp.errNormal) & "," & vbCrLf
        sql = sql & " FIKYCTE = " & IIf(kyctErr, mYimp.errWarning, mYimp.errNormal) & "," & vbCrLf
        sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
        sql = sql & " FIUPDT = SYSDATE" & vbCrLf
        sql = sql & " WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(dynM.Fields("FIINDT"), "D", vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss')" & vbCrLf
        sql = sql & "   AND FISEQN = " & gdDBS.ColumnDataSet(dynM.Fields("FISEQN"), "L", vEnd:=True) & vbCrLf
        sql = sql & "   AND FIRKBN = " & mYimp.RecordIsTotal & vbCrLf
        recCnt = gdDBS.Database.ExecuteSQL(sql)
        Call dynM.MoveNext
    Loop
    Call dynM.Close
    Set dynM = Nothing
    pgrProgressBar.Max = cMaxBlock
    '//////////////////////////////////////////////////
    '//ëSëÃÉGÉâÅ[çÄñ⁄ÉZÉbÉgÅFç≈èâÇ…ê≥èÌÇ…ÇµÇƒÇ¢ÇÈÇÃÇ≈Åuê≥èÌÅvÉtÉâÉOÇÕïsóv
    '//àŸèÌÉfÅ[É^
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIOKFG =  " & mYimp.updInvalid & "," & vbCrLf    '//É}ÉXÉ^îΩâfïsâ¬
    sql = sql & " FIERROR = " & mYimp.errInvalid & "," & vbCrLf
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE(" & vbCrLf
    sql = sql & mYimp.StatusColumns(" = " & mYimp.errInvalid & vbCrLf & " OR ", Len(vbCrLf & " OR ")) & vbCrLf & ")" & vbCrLf
    sql = sql & SameConditions & vbCrLf
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//////////////////////////////////////////////////
    '//ëSëÃÉGÉâÅ[çÄñ⁄ÉZÉbÉgÅFç≈èâÇ…ê≥èÌÇ…ÇµÇƒÇ¢ÇÈÇÃÇ≈Åuê≥èÌÅvÉtÉâÉOÇÕïsóv
    '//åxçêÉfÅ[É^ÅFÉ}ÉXÉ^îΩâfÇµÇ»Ç¢ÉfÅ[É^
    '//////////////////////////////////////////////////
    If False = pProgressBarSet(Block) Then
        GoTo gDataCheckError:
    End If
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIOKFG =  " & mYimp.updWarnErr & "," & vbCrLf   '//É}ÉXÉ^îΩâfÇµÇ»Ç¢ÉtÉâÉO
    sql = sql & " FIERROR = " & mYimp.errWarning & "," & vbCrLf
    sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
    sql = sql & " FIUPDT = SYSDATE" & vbCrLf
    sql = sql & " WHERE FIERROR = " & mYimp.errNormal & vbCrLf    '//àŸèÌÇ≈ñ≥Ç¢
    sql = sql & "   AND FIOKFG <= " & mYimp.updNormal & vbCrLf
    sql = sql & "   AND(" & vbCrLf
    sql = sql & mYimp.StatusColumns(" >= " & mYimp.errWarning & vbCrLf & " OR ", Len(vbCrLf & " OR ")) & vbCrLf & ")" & vbCrLf
    sql = sql & SameConditions & vbCrLf
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    '//////////////////////////////////////////////////
    '//ñæç◊ÇÃÉGÉâÅ[ÇçáåvÇ…ì]ãL
    '//////////////////////////////////////////////////
    Dim okFlag As Integer, erFlag As Integer
    '//çáåvÉåÉRÅ[ÉhÇÃéÊìæ
    sql = "SELECT * FROM " & mYimp.TfFurikaeImport & vbCrLf
    sql = sql & " WHERE FIRKBN = " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & SameConditions & vbCrLf
    sql = sql & " ORDER BY FIITKB,FIKYCD,FIKSCD" & vbCrLf
#If ORA_DEBUG = 1 Then
    Set dynM = gdDBS.OpenRecordset(sql, dynOption.ORADYN_READONLY)
#Else
    Set dynM = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
#End If
    sqlStep = 0
    If Not dynM.EOF Then
        pgrProgressBar.Value = 0
        pgrProgressBar.Max = dynM.RecordCount
    End If
    Do Until dynM.EOF
        '//////////////////////////////////////////////////
        '// DoEvents ÇÕ pProgressBarSet() ÇÃíÜÇ≈é¿çsÇ≥ÇÍÇƒÇ¢ÇÈ
        If False = pProgressBarSet(Block, sqlStep) Then
            GoTo gDataCheckError:
        End If
        '//ñæç◊çsÇÃåãâ ÇéÊìæ
        '//ÉåÉXÉ|ÉìÉXÇÕíxÇ¢Ç©Ç‡ÅH
        '//2006/04/13 NULL ÉGÉâÅ[âÒî
        sql = "SELECT NVL(MIN(NVL(FIOKFG,0)),0)  FIOKFG," & vbCrLf
        '//               ??ERROR => -1:àŸèÌÉfÅ[É^ / 0:ê≥èÌÉfÅ[É^ / 1:åxçêÉfÅ[É^ Ç∆Ç»Ç¡ÇƒÇ¢ÇÈÇÃÇ≈íçà”
        sql = sql & " NVL(MIN(NVL(FIERROR,0)),0) minERROR," & vbCrLf
        sql = sql & " NVL(MAX(NVL(FIERROR,0)),0) maxERROR " & vbCrLf
        sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
        sql = sql & " WHERE       (" & cInSQLString & ") IN(" & vbCrLf
        sql = sql & "       SELECT " & cInSQLString & vbCrLf
        sql = sql & "       FROM " & mYimp.TfFurikaeImport & " b " & vbCrLf
        sql = sql & "       WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(dynM.Fields("FIINDT"), "D", vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss')" & vbCrLf
        sql = sql & "         AND FISEQN = " & gdDBS.ColumnDataSet(dynM.Fields("FISEQN"), "L", vEnd:=True) & vbCrLf
        sql = sql & "         AND FIRKBN = " & mYimp.RecordIsTotal & vbCrLf
        sql = sql & "       )"
        sql = sql & "   AND FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf
#If ORA_DEBUG = 1 Then
        Set dynS = gdDBS.OpenRecordset(sql, dynOption.ORADYN_READONLY)
#Else
        Set dynS = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
#End If
        '//ñæç◊ÇÃÉGÉâÅ[Ç™çáåvÇÊÇËÇ‡ê[çèÇ»ÇÁÅIÉtÉâÉOÇÕïâêîÇ»ÇÃÇ≈ãtì]Ç∑ÇÈ
        '// OKFG ÇÃîªíf
        If Val(dynM.Fields("FIOKFG")) = mYimp.errNormal And Val(dynS.Fields("FIOKFG")) <> mYimp.errNormal Then
            okFlag = dynS.Fields("FIOKFG")
        Else
            okFlag = dynM.Fields("FIOKFG")
        End If
        '// ERROR ÇÃîªíf
        If Val(dynS.Fields("minERROR")) = mYimp.errNormal And Val(dynS.Fields("maxERROR")) = mYimp.errNormal Then
            '//ñæç◊Ç™Ç∑Ç◊ÇƒÅuê≥èÌÅvÇ»ÇÁçáåvÇÃÉGÉâÅ[èÓïÒ
            erFlag = dynM.Fields("FIERROR")
        ElseIf Val(dynM.Fields("FIERROR")) = mYimp.errNormal Then
            '//çáåvÇ™Åuê≥èÌÅv
            If Val(dynS.Fields("minERROR")) = mYimp.errInvalid Then
                '//ñæç◊Ç™ÅuàŸèÌÅvÇ»ÇÁçáåvÇ‡ÅuàŸèÌÅv
                erFlag = dynS.Fields("minERROR")
            ElseIf Val(dynS.Fields("maxERROR")) = mYimp.errWarning Then
                '//ñæç◊Ç™ÅuåxçêÅvÇ»ÇÁçáåvÇ‡ÅuåxçêÅv
                erFlag = dynS.Fields("maxERROR")
            Else
                erFlag = dynM.Fields("FIERROR") '//Ç†ÇËìæÇ»Ç¢ÅH
            End If
        ElseIf Val(dynM.Fields("FIERROR")) = mYimp.errWarning And Val(dynS.Fields("minERROR")) = mYimp.errInvalid Then
            '//çáåvÇ™ÅuåxçêÅvÇ≈ñæç◊Ç™ÅuàŸèÌÅvÇ»ÇÁçáåvÇÕÅuàŸèÌÅv
            erFlag = dynS.Fields("minERROR")
        Else
            erFlag = dynM.Fields("FIERROR")
        End If
        '//çáåvçsÇ…çXêV
        sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
        sql = sql & " FIOKFG  = " & okFlag & "," & vbCrLf
        sql = sql & " FIERROR = " & erFlag & "," & vbCrLf
        sql = sql & " FIUSID = '" & gdDBS.LoginUserName & "'," & vbCrLf
        sql = sql & " FIUPDT = SYSDATE" & vbCrLf
        sql = sql & " WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(dynM.Fields("FIINDT"), "D", vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss')" & vbCrLf
        sql = sql & "   AND FISEQN = " & gdDBS.ColumnDataSet(dynM.Fields("FISEQN"), "L", vEnd:=True) & vbCrLf
        sql = sql & "   AND FIRKBN = " & mYimp.RecordIsTotal & vbCrLf
        recCnt = gdDBS.Database.ExecuteSQL(sql)
        Call dynM.MoveNext
    Loop
    Call dynM.Close
    Set dynM = Nothing
    pgrProgressBar.Max = cMaxBlock
    
    Call gdDBS.Database.CommitTrans         '//ÉgÉâÉìÉUÉNÉVÉáÉìê≥èÌèIóπ
    fraProgressBar.Visible = False
    Call gdDBS.AutoLogOut(mCaption, "[" & vImpDate & "] ÇÃÉ`ÉFÉbÉNèàóùÇ™äÆóπÇµÇ‹ÇµÇΩÅB")
    '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
    stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "É`ÉFÉbÉNäÆóπ"
    pDataCheck = True

#If BLOCK_CHECK = True Then           '//É`ÉFÉbÉNéûÇÃÉuÉçÉbÉNÇ™Ç¢Ç≠Ç¬Ç†ÇÈÇ©ÅHÇï\é¶ÅFÉfÉoÉbÉNéûÇÃÇ›
     Call MsgBox("É`ÉFÉbÉNÇµÇΩÉuÉçÉbÉNÇÕ " & mCheckBlocks & " â”èäÇ≈ÇµÇΩÅB")
#End If
    
    Exit Function
gDataCheckError:
    fraProgressBar.Visible = False
    Call gdDBS.Database.Rollback            '//ÉgÉâÉìÉUÉNÉVÉáÉìàŸèÌèIóπ
    If Err Then
        Dim errCode As Integer, errMsg As String
        If gdDBS.Database.LastServerErr Then
            errCode = gdDBS.Database.LastServerErr
            errMsg = gdDBS.Database.LastServerErrText
        Else
            errCode = Err
            errMsg = Error
        End If
        fraProgressBar.Visible = False
        '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "É`ÉFÉbÉNÉGÉâÅ[(" & errCode & ")"
        Call gdDBS.AutoLogOut(mCaption, "[" & vImpDate & "] ÇÃÉ`ÉFÉbÉNèàóùíÜÇ…ÉGÉâÅ[Ç™î≠ê∂ÇµÇ‹ÇµÇΩÅB(Error=" & errCode & ")")
        Call MsgBox("É`ÉFÉbÉNëŒè€ = [" & cboImpDate.Text & "]" & vbCrLf & _
                    "ÇÕÉGÉâÅ[Ç™î≠ê∂ÇµÇΩÇΩÇﬂÉ`ÉFÉbÉNÇÕíÜé~Ç≥ÇÍÇ‹ÇµÇΩÅB" & vbCrLf & errMsg, _
                vbOKOnly + vbCritical, mCaption)
    Else
        Call gdDBS.AutoLogOut(mCaption, "[" & vImpDate & "] ÇÃÉ`ÉFÉbÉNèàóùÇ™íÜífÇ≥ÇÍÇ‹ÇµÇΩÅB")
        '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "É`ÉFÉbÉNíÜíf"
    End If
End Function

Private Sub cmdCheck_Click()
    If True = pSpreadCheckAndUpdate(sprTotal.Tag = mSprTotal.RowEdit Or sprDetail.Tag = mSprDetail.RowEdit) Then
        Exit Sub
    End If
    If -1 <> pAbortButton(cmdCheck, cBtnCheck) Then
        Exit Sub
    End If
    cmdCheck.Caption = cBtnCancel
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(False, cmdCheck)
    '//É`ÉFÉbÉNèàóù
    If True = pDataCheck(cboImpDate.Text) Then
        '//ÉfÅ[É^ì«Ç›çûÇ›Åï Spread Ç…ê›íËîΩâf
        Call pReadTotalDataAndSetting
    End If
    '//É{É^ÉìÇñﬂÇ∑
    cmdCheck.Caption = cBtnCheck
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(True)
End Sub

Private Sub cmdDelete_Click()
    If True = pSpreadCheckAndUpdate(sprTotal.Tag = mSprTotal.RowEdit Or sprDetail.Tag = mSprDetail.RowEdit) Then
        Exit Sub
    End If
    If vbOK <> MsgBox("åªç›ï\é¶Ç≥ÇÍÇƒÇ¢ÇÈÉfÅ[É^Çîjä¸ÇµÇ‹Ç∑." & vbCrLf & vbCrLf & _
                      "îpä¸ëŒè€ = [" & cboImpDate.Text & "]" & vbCrLf & vbCrLf & _
                      "ÇÊÇÎÇµÇ¢Ç≈Ç∑Ç©ÅH", vbOKCancel + vbInformation, mCaption) Then
        Exit Sub
    End If
    If -1 <> pAbortButton(cmdDelete, cBtnDelete) Then
        Exit Sub
    End If
    cmdDelete.Caption = cBtnCancel
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(False, cmdDelete)
    
    Dim ms As New MouseClass, recCnt As Long
    Call ms.Start
    
    Call gdDBS.AutoLogOut(mCaption, "[" & cboImpDate.Text & "] ÇÃîpä¸Ç™äJénÇ≥ÇÍÇ‹ÇµÇΩÅB")
    
    On Error GoTo cmdDelete_ClickErr:
    Call gdDBS.Database.BeginTrans
    
    '//É}ÉXÉ^îΩâféûÇ…Ç‡ìØÇ∂éñÇÇ∑ÇÈÇÃÇ≈ã§í âª
    recCnt = pMoveTempRecords(" AND FIINDT = TO_DATE('" & cboImpDate.Text & "','yyyy/mm/dd hh24:mi:ss')", cImportToDelete)
    If recCnt < 0 Then
        GoTo cmdDelete_ClickErr:
    End If
    
    Call gdDBS.Database.CommitTrans
    
    Set ms = Nothing
    Call MsgBox("îpä¸ëŒè€ = [" & cboImpDate.Text & "]" & vbCrLf & vbCrLf & _
                recCnt & " åèÇ™îpä¸Ç≥ÇÍÇ‹ÇµÇΩ.", vbOKOnly + vbInformation, mCaption)
    
    '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
    stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "îpä¸äÆóπ"
    Call gdDBS.AutoLogOut(mCaption, "[" & cboImpDate.Text & "] ÇÃ " & recCnt & " åèÇÃîpä¸Ç™äÆóπÇµÇ‹ÇµÇΩÅB")
    
    Call pMakeComboBox
    '//É{É^ÉìÇñﬂÇ∑
    cmdDelete.Caption = cBtnDelete
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(True)
    Exit Sub
cmdDelete_ClickErr:
    Call gdDBS.Database.Rollback
    If Err Then
        Dim errCode As Integer, errMsg As String
        If gdDBS.Database.LastServerErr Then
            errCode = gdDBS.Database.LastServerErr
            errMsg = gdDBS.Database.LastServerErrText
        Else
            errCode = Err
            errMsg = Error
        End If
        fraProgressBar.Visible = False
        '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "îpä¸ÉGÉâÅ[(" & errCode & ")"
        Call gdDBS.AutoLogOut(mCaption, "ÉGÉâÅ[Ç™î≠ê∂ÇµÇΩÇΩÇﬂîpä¸ÇÕíÜé~Ç≥ÇÍÇ‹ÇµÇΩÅB(Error=" & errMsg & ")")
        Call MsgBox("îpä¸ëŒè€ = [" & cboImpDate.Text & "]" & vbCrLf & _
                    "ÇÕÉGÉâÅ[Ç™î≠ê∂ÇµÇΩÇΩÇﬂîpä¸ÇÕíÜé~Ç≥ÇÍÇ‹ÇµÇΩÅB" & vbCrLf & errMsg, _
                vbOKOnly + vbCritical, mCaption)
    Else
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "îpä¸íÜíf"
        Call gdDBS.AutoLogOut(mCaption, "[" & cboImpDate.Text & "] ÇÃîpä¸ÇÕíÜé~Ç≥ÇÍÇ‹ÇµÇΩÅB")
    End If
    '//É{É^ÉìÇñﬂÇ∑
    cmdDelete.Caption = cBtnDelete
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(True)
End Sub

Private Sub cmdEnd_Click()
    If True = pSpreadCheckAndUpdate(sprTotal.Tag = mSprTotal.RowEdit Or sprDetail.Tag = mSprDetail.RowEdit) Then
        Exit Sub
    End If
    Unload Me
End Sub

Private Sub pLockedControl(blMode As Boolean, Optional vButton As CommandButton = Nothing)
    cmdImport.Enabled = blMode
    cmdCheck.Enabled = blMode
    cmdErrList.Enabled = blMode
    cmdDelete.Enabled = blMode
    cmdUpdate.Enabled = blMode
    cmdSprUpdate.Enabled = False    '//èÌÇ…égópïsâ¬ÅASpread èCê≥ÉtÉâÉOÇ∆ìØéûÇ…égópâ¬
    cmdEnd.Enabled = blMode     '//èàóùìríÜÇ≈èIóπÇ∑ÇÈÇ∆Ç®Ç©ÇµÇ≠Ç»ÇÈÇÃÇ≈èIóπÇ‡éEÇ∑ÅI
    If Not vButton Is Nothing Then
        vButton.Enabled = True
    End If
End Sub

Private Function pAbortButton(vButton As CommandButton, vCaption As String) As Integer
    pAbortButton = -1   '// -1 = èàóùäJén
    mAbort = False
    If vButton.Caption <> cBtnCancel Then
        Exit Function
    End If
    pAbortButton = MsgBox(Left(vCaption, InStr(vCaption, "(") - 1) & "ÇíÜé~ÇµÇ‹Ç∑Ç©ÅH", vbInformation + vbOKCancel, mCaption)
    If vbOK <> pAbortButton Then
        Exit Function   '//íÜé~ÇÇ‚ÇﬂÇΩÅI
    End If
    vButton.Caption = vCaption
    mAbort = True
End Function

Private Sub pReadTotalDataAndSetting()
    
    dbcImportTotal.RecordSource = pMakeSQLReadDataTotal
    '//íºê⁄ï“èWÇ∑ÇÈÇÃÇ≈âºëzÉÇÅ[ÉhÇ…ÇµÇ»Ç¢
    'sprMeisai.VirtualMode = False   '//àÍíUâºëzÉÇÅ[Éhâèú
    Call dbcImportTotal.Refresh
    sprTotal.VScrollSpecial = True
    sprTotal.VScrollSpecialType = 0
    sprTotal.MaxRows = dbcImportTotal.Recordset.RecordCount
    '//ÉZÉãíPà Ç…ÉGÉâÅ[â”èäÇÉJÉâÅ[ï\é¶
    Call pSpreadTotalSetErrorStatus(True)
    '//ToolTip ÇóLå¯Ç…Ç∑ÇÈà◊Ç…ã≠êßìIÇ…ÉtÉHÅ[ÉJÉXÇà⁄Ç∑ÅFForm_Load()íÜÇ»ÇÃÇ≈ÉGÉâÅ[Ç…Ç»ÇÈÅI
    On Error Resume Next
    Call sprTotal.SetFocus
    mLeaveCellEvents = False    '//ãNìÆéûÇÃÇPâÒñ⁄ÇÃÇ› LeaveCell ÉCÉxÉìÉgÇ™î≠ê∂ÇµÇ»Ç¢ÇÃÇ≈êßå‰
    '//èâä˙ï\é¶ÇÕÇOåèÅAçáåvÉNÉäÉbÉNéûÇ…ï\é¶Ç≥ÇÍÇÈÇÊÇ§Ç…...ÅB
    dbcImportDetail.RecordSource = ""
    sprDetail.MaxRows = 0
    '//çáåvëSëÃÇÃèCê≥ÉtÉâÉOÇÉäÉZÉbÉg
    sprTotal.Tag = mSprTotal.RowNonEdit
End Sub

Private Sub pReadDetailDataAndSetting(vImpDate As String, vSeqNo As Long)
    
    dbcImportDetail.RecordSource = pMakeSQLReadDataDetail(vImpDate, vSeqNo)
    '//íºê⁄ï“èWÇ∑ÇÈÇÃÇ≈âºëzÉÇÅ[ÉhÇ…ÇµÇ»Ç¢
    'sprMeisai.VirtualMode = False   '//àÍíUâºëzÉÇÅ[Éhâèú
    Call dbcImportDetail.Refresh
    sprDetail.VScrollSpecial = True
    sprDetail.VScrollSpecialType = 0
    sprDetail.MaxRows = dbcImportDetail.Recordset.RecordCount
    
    '//ñæç◊ÇÃçáåvÇï\é¶
#If ORA_DEBUG = 1 Then
    Dim sql As String, dyn As OraDynaset
#Else
    Dim sql As String, dyn As Object
#End If
    sql = "SELECT " & vbCrLf
    '//ïœçXåèêîÇ…ÇÕâñÒÇä‹Ç‹Ç»Ç¢
    'sql = sql & " COUNT(*) FIHKCT,"& vbCrLf
    sql = sql & " SUM(DECODE(NVL(FIKYFG,0),0,1,0)) FIHKCT," & vbCrLf
    sql = sql & " SUM(       NVL(FIHKKG,0)       ) FIHKKG," & vbCrLf
    sql = sql & " SUM(DECODE(NVL(FIKYFG,0),0,0,1)) FIKYCT " & vbCrLf
    sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
    sql = sql & " WHERE   (" & cInSQLString & ") IN(" & vbCrLf
    sql = sql & "   SELECT " & cInSQLString & vbCrLf
    sql = sql & "   FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
    sql = sql & "   WHERE FIINDT = TO_DATE('" & vImpDate & "','yyyy/mm/dd hh24:mi:ss')" & vbCrLf
    sql = sql & "     AND FISEQN = " & gdDBS.ColumnDataSet(vSeqNo, vEnd:=True) & vbCrLf
    sql = sql & "   )" & vbCrLf
'z 2006/06/13 èdï°ÉfÅ[É^éûÇÃèCê≥
'z    sql = sql & "   AND FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & "   AND FIRKBN = " & vSeqNo & vbCrLf
#If ORA_DEBUG = 1 Then
    Set dyn = gdDBS.OpenRecordset(sql, dynOption.ORADYN_READONLY)
#Else
    Set dyn = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
#End If
    lblDetailCount.Caption = Format(dyn.Fields("FIHKCT"), "#,##0")
    lblDetailKingaku.Caption = Format(dyn.Fields("FIHKKG"), "#,##0")
    lblDetailCancel.Caption = Format(dyn.Fields("FIKYCT"), "#,##0")
    Call dyn.Close
    Set dyn = Nothing

    '//ÉZÉãíPà Ç…ÉGÉâÅ[â”èäÇÉJÉâÅ[ï\é¶
    Call pSpreadDetailSetErrorStatus(vImpDate, vSeqNo)
    '//ñæç◊ëSëÃÇÃèCê≥ÉtÉâÉOÇÉäÉZÉbÉg
    sprDetail.Tag = mSprDetail.RowEdit
End Sub

Private Function pMakeSQLReadDataTotal() As String
    Dim sql As String
    
    sql = "SELECT * FROM(" & vbCrLf
    sql = sql & "SELECT " & vbCrLf
    'sql = sql & " CIERROR," & vbCrLf
#If SHORT_MSG Then
    sql = sql & " DECODE(FIERROR,-4,'çÌèú',-3,'éÊçû',-2,'èCê≥',-1,'àŸèÌ',0,'ê≥èÌ',1,'åxçê','ó·äO') as CIERRNM," & vbCrLf
#Else
    sql = sql & " CASE WHEN FIERROR = -2 THEN " & gdDBS.ColumnDataSet(cEditDataMsg, vEnd:=True) & vbCrLf
    sql = sql & "      WHEN FIERROR = -3 THEN " & gdDBS.ColumnDataSet(cImportMsg, vEnd:=True) & vbCrLf
'//2006/06/16 ñæç◊çÌèúëŒâû
    sql = sql & "      WHEN FIERROR = -4 THEN " & gdDBS.ColumnDataSet(cDeleteMsg, vEnd:=True) & vbCrLf
    sql = sql & "      WHEN FIERROR IN(-1,+0,+1) THEN " & vbCrLf
    sql = sql & "           DECODE(FIERROR," & vbCrLf
    sql = sql & "               -1,'àŸèÌ'," & vbCrLf
    sql = sql & "               +0,'ê≥èÌ'," & vbCrLf
    sql = sql & "               +1,'åxçê'," & vbCrLf
    sql = sql & "               NULL" & vbCrLf
    sql = sql & "           ) || ' => ' || " & vbCrLf
    sql = sql & "       DECODE(FIOKFG," & vbCrLf
    sql = sql & "               " & mYimp.updInvalid & ",'" & mYimp.mUpdateMessage(mYimp.updInvalid) & "'," & vbCrLf
    sql = sql & "               " & mYimp.updWarnErr & ",'" & mYimp.mUpdateMessage(mYimp.updWarnErr) & "'," & vbCrLf
    sql = sql & "               " & mYimp.updNormal & ",'" & mYimp.mUpdateMessage(mYimp.updNormal) & "'," & vbCrLf
    sql = sql & "               " & mYimp.updWarnUpd & ",'" & mYimp.mUpdateMessage(mYimp.updWarnUpd) & "'," & vbCrLf
    '//ÇªÇÒÇ»ÉfÅ[É^ÇÕñ≥Ç¢
    'sql = sql & "               " & mYimp.updResetCancel & ",'" & mYimp.mUpdateMessage(mYimp.updResetCancel) & "'," & vbCrLf
    sql = sql & "               'èàóùåãâ Ç™ì¡íËÇ≈Ç´Ç‹ÇπÇÒÅB'" & vbCrLf
    sql = sql & "           )" & vbCrLf
    sql = sql & "      ELSE                             'ó·äO => èàóùåãâ Ç™ì¡íËÇ≈Ç´Ç‹ÇπÇÒÅB'" & vbCrLf
    sql = sql & " END as FIERRNM," & vbCrLf
'//2006/04/26 éùçûì˙ÅEâÒêîï\é¶
    sql = sql & " TO_CHAR(TO_DATE(FIMCDT,'YYYYMMDD'),'yyyy/mm/dd') FIMCDT," & vbCrLf
'    sql = sql & " CASE WHEN NVL(FIICNT,0) <= 1 THEN NULL ELSE FIICNT END FIICNT," & vbCrLf
    sql = sql & " FIICNT," & vbCrLf
#End If
    sql = sql & " (SELECT ABKJNM " & vbCrLf
    sql = sql & "  FROM taItakushaMaster" & vbCrLf
    sql = sql & "  WHERE ABITKB = a.FIITKB" & vbCrLf
    sql = sql & " ) as ABKJNM," & vbCrLf    '//í èÌÇÃäOïîåãçáÇ≈Ç∑ÇÈÇ∆Ç‚Ç‚Ç±ÇµÇ¢ÇÃÇ≈...(tcHogoshaImport Table ÇÕëSåèèoÇµÇΩÇ¢ÅI)
    sql = sql & " FIKYCD," & vbCrLf
'//2006/04/13 ï°êîåèåãâ Ç™Ç†ÇÈÇÃÇ≈ÉGÉâÅ[Ç…Ç»ÇÈëŒâû DISTINCT
    sql = sql & " (SELECT MAX(BAKJNM) BAKJNM " & vbCrLf
    sql = sql & "  FROM tbKeiyakushaMaster " & vbCrLf
    sql = sql & "  WHERE BAITKB = a.FIITKB" & vbCrLf
    sql = sql & "    AND BAKYCD = a.FIKYCD" & vbCrLf
'//2006/05/17 ç≈êVÇÃå_ñÒé“Çï\é¶Ç∑ÇÈà◊ïúäà : If 0 Then => If 1 Then
#If 1 Then  '//2006/04/05 ë∂ç›Ç∑ÇÍÇŒÉGÉâÅ[Ç…ÇµÇ»Ç¢
    '//å_ñÒé“ÇÕåªç›óLå¯ï™ÅFå_ñÒä˙ä‘ÅïêUë÷ä˙ä‘
    sql = sql & "    AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN BAKYST AND BAKYED" & vbCrLf
    sql = sql & "    AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN BAFKST AND BAFKED" & vbCrLf
#End If
    sql = sql & " ) as BAKJNM," & vbCrLf    '//í èÌÇÃäOïîåãçáÇ≈Ç∑ÇÈÇ∆Ç‚Ç‚Ç±ÇµÇ¢ÇÃÇ≈...(tcHogoshaImport Table ÇÕëSåèèoÇµÇΩÇ¢ÅI)
    sql = sql & " FIKSCD," & vbCrLf
    sql = sql & " FIPGNO," & vbCrLf
    sql = sql & " TO_CHAR(TO_DATE(FIFKDT,'YYYYMMDD'),'yyyy/mm/dd') FIFKDT," & vbCrLf
    sql = sql & " FIHKCT," & vbCrLf
    sql = sql & " FIHKKG," & vbCrLf
    sql = sql & " FIKYCT," & vbCrLf
    sql = sql & " TO_CHAR(FIINDT,'yyyy/mm/dd hh24:mi:ss') FIINDT," & vbCrLf
    sql = sql & " FISEQN," & vbCrLf
    sql = sql & " FIITKB," & vbCrLf
    sql = sql & " FIERROR," & vbCrLf
    sql = sql & mSprTotal.RowNonEdit & " AS EditFlag "
    sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
    sql = sql & " WHERE FIINDT = TO_DATE('" & cboImpDate.Text & "','yyyy/mm/dd hh24:mi:ss')" & vbCrLf
    sql = sql & "   AND FIRKBN = " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & " ORDER BY " & cSQLOrderString & vbCrLf    'èCê≥ÅAÉGÉâÅ[ÅAåxçêÅAê≥èÌÇÃèá
    '//à»ç~ÇÃÇnÇqÇcÇdÇqãÂ
    Select Case cboSort.ListIndex
    Case eSort.eImportSeq
        sql = sql & ",FIINDT,FISEQN" & vbCrLf
    Case eSort.eKeiyakusha
        sql = sql & ",FIITKB,FIKYCD,FIKSCD,FIPGNO,FIFKDT,FIHGCD,FISEQN" & vbCrLf
    Case Else
    End Select
    sql = sql & ")" & vbCrLf
    pMakeSQLReadDataTotal = sql
End Function

Private Function pMakeSQLReadDataDetail(vDate As String, vSeqNo As Long) As String
    Dim sql As String
    
    sql = "SELECT * FROM(" & vbCrLf
    sql = sql & "SELECT " & vbCrLf
    'sql = sql & " CIERROR," & vbCrLf
#If SHORT_MSG Then
    sql = sql & " DECODE(FIERROR,-3,'éÊçû',-2,'èCê≥',-1,'àŸèÌ',0,'ê≥èÌ',1,'åxçê','ó·äO') as CIERRNM," & vbCrLf
#Else
    sql = sql & " CASE WHEN FIERROR = -2 THEN " & gdDBS.ColumnDataSet(cEditDataMsg, vEnd:=True) & vbCrLf
    sql = sql & "      WHEN FIERROR = -3 THEN " & gdDBS.ColumnDataSet(cImportMsg, vEnd:=True) & vbCrLf
'//2006/06/16 ñæç◊çÌèúëŒâû
    sql = sql & "      WHEN FIERROR = -4 THEN " & gdDBS.ColumnDataSet(cDeleteMsg, vEnd:=True) & vbCrLf
    sql = sql & "      WHEN FIERROR IN(-1,+0,+1) THEN " & vbCrLf
    sql = sql & "           DECODE(FIERROR," & vbCrLf
    sql = sql & "               -1,'àŸèÌ'," & vbCrLf
    sql = sql & "               +0,'ê≥èÌ'," & vbCrLf
    sql = sql & "               +1,'åxçê'," & vbCrLf
    sql = sql & "               NULL" & vbCrLf
    sql = sql & "           ) || ' => ' || " & vbCrLf
    sql = sql & "       DECODE(FIOKFG," & vbCrLf
    sql = sql & "               " & mYimp.updInvalid & ",'" & mYimp.mUpdateMessage(mYimp.updInvalid) & "'," & vbCrLf
    sql = sql & "               " & mYimp.updWarnErr & ",'" & mYimp.mUpdateMessage(mYimp.updWarnErr) & "'," & vbCrLf
    sql = sql & "               " & mYimp.updNormal & ",'" & mYimp.mUpdateMessage(mYimp.updNormal) & "'," & vbCrLf
    sql = sql & "               " & mYimp.updWarnUpd & ",'" & mYimp.mUpdateMessage(mYimp.updWarnUpd) & "'," & vbCrLf
    '//ÇªÇÒÇ»ÉfÅ[É^ÇÕñ≥Ç¢
    'sql = sql & "               " & mYimp.updResetCancel & ",'" & mYimp.mUpdateMessage(mYimp.updResetCancel) & "'," & vbCrLf
    sql = sql & "               'èàóùåãâ Ç™ì¡íËÇ≈Ç´Ç‹ÇπÇÒÅB'" & vbCrLf
    sql = sql & "           )" & vbCrLf
    sql = sql & "      ELSE                             'ó·äO => èàóùåãâ Ç™ì¡íËÇ≈Ç´Ç‹ÇπÇÒÅB'" & vbCrLf
    sql = sql & " END as FIERRNM," & vbCrLf
'//2006/04/26 éùçûì˙ÅEâÒêîï\é¶
    sql = sql & " TO_CHAR(TO_DATE(FIMCDT,'YYYYMMDD'),'yyyy/mm/dd') FIMCDT," & vbCrLf
'    sql = sql & " CASE WHEN NVL(FIICNT,0) <= 1 THEN NULL ELSE FIICNT END FIICNT," & vbCrLf
    sql = sql & " FIICNT," & vbCrLf
#End If
    sql = sql & " FIHGCD," & vbCrLf
'//2006/04/13 ï°êîåèåãâ Ç™Ç†ÇÈÇÃÇ≈ÉGÉâÅ[Ç…Ç»ÇÈëŒâû DISTINCT
'//2006/04/27 ÉpÉìÉ`ÉfÅ[É^Ç…å˚ç¿ñºã`êlñºÇí«â¡ÇµÇΩà◊ïœçX CAKJNM=>CAKZNM
    sql = sql & " (SELECT DISTINCT CAKZNM " & vbCrLf
    sql = sql & "  FROM tcHogoshaMaster " & vbCrLf
    sql = sql & "  WHERE CAITKB = a.FIITKB" & vbCrLf
    sql = sql & "    AND CAKYCD = a.FIKYCD" & vbCrLf
    sql = sql & "    AND CAKSCD = a.FIKSCD" & vbCrLf    '//2006/04/13 ã≥é∫í«â¡
    sql = sql & "    AND CAHGCD = a.FIHGCD" & vbCrLf
#If 0 Then  '//2006/04/05 ë∂ç›Ç∑ÇÍÇŒÉGÉâÅ[Ç…ÇµÇ»Ç¢
    '//ï€åÏé“ÇÕåªç›óLå¯ï™ÅFå_ñÒä˙ä‘ÅïêUë÷ä˙ä‘
    sql = sql & "    AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN CAKYST AND CAKYED" & vbCrLf
    sql = sql & "    AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN CAFKST AND CAFKED" & vbCrLf
#End If
'//2006/04/27 ÉpÉìÉ`ÉfÅ[É^Ç…å˚ç¿ñºã`êlñºÇí«â¡ÇµÇΩà◊ïœçX CAKJNM=>CAKZNM
    sql = sql & " ) as CAKZNM," & vbCrLf    '//í èÌÇÃäOïîåãçáÇ≈Ç∑ÇÈÇ∆Ç‚Ç‚Ç±ÇµÇ¢ÇÃÇ≈...(tcHogoshaImport Table ÇÕëSåèèoÇµÇΩÇ¢ÅI)
'//2006/04/27 ÉpÉìÉ`ÉfÅ[É^Ç…å˚ç¿ñºã`êlñºÇí«â¡ÇµÇΩà◊ïœçX
#If 1 Then
    sql = sql & " FIKZNM,"
#Else
    '//2006/04/05 âñÒé“Çï\é¶
    '//    sql = sql & " (SELECT CAKNNM " & vbCrLf
    '//2006/04/13 ï°êîåèåãâ Ç™Ç†ÇÈÇÃÇ≈ÉGÉâÅ[Ç…Ç»ÇÈëŒâû DISTINCT
        sql = sql & " (SELECT DISTINCT DECODE(NVL(CAKYFG,0),0,CAKNNM,'(âñÒ)')" & vbCrLf
        sql = sql & "  FROM tcHogoshaMaster " & vbCrLf
        sql = sql & "  WHERE CAITKB = a.FIITKB" & vbCrLf
        sql = sql & "    AND CAKYCD = a.FIKYCD" & vbCrLf
        sql = sql & "    AND CAKSCD = a.FIKSCD" & vbCrLf    '//2006/04/13 ã≥é∫í«â¡
        sql = sql & "    AND CAHGCD = a.FIHGCD" & vbCrLf
    #If 0 Then  '//2006/04/05 ë∂ç›Ç∑ÇÍÇŒÉGÉâÅ[Ç…ÇµÇ»Ç¢
        '//ï€åÏé“ÇÕåªç›óLå¯ï™ÅFå_ñÒä˙ä‘ÅïêUë÷ä˙ä‘
        sql = sql & "    AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN CAKYST AND CAKYED" & vbCrLf
        sql = sql & "    AND TO_CHAR(SYSDATE,'yyyymmdd') BETWEEN CAFKST AND CAFKED" & vbCrLf
    #End If
        sql = sql & " ) as CAKNNM," & vbCrLf    '//í èÌÇÃäOïîåãçáÇ≈Ç∑ÇÈÇ∆Ç‚Ç‚Ç±ÇµÇ¢ÇÃÇ≈...(tcHogoshaImport Table ÇÕëSåèèoÇµÇΩÇ¢ÅI)
#End If
    sql = sql & " FIHKKG," & vbCrLf
    sql = sql & " FIKYFG," & vbCrLf
    sql = sql & " TO_CHAR(FIINDT,'yyyy/mm/dd hh24:mi:ss') FIINDT," & vbCrLf
    sql = sql & " FISEQN," & vbCrLf
    sql = sql & " FIITKB," & vbCrLf
    sql = sql & " FIKYCD," & vbCrLf
    sql = sql & " FIKSCD," & vbCrLf
    sql = sql & " FIPGNO," & vbCrLf
    sql = sql & " TO_CHAR(TO_DATE(FIFKDT,'YYYYMMDD'),'yyyy/mm/dd') FIFKDT," & vbCrLf
    sql = sql & " FIERROR," & vbCrLf
    sql = sql & mSprDetail.RowNonEdit & " AS EditFlag " & vbCrLf
    sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
    sql = sql & " WHERE   (" & cInSQLString & ") IN(" & vbCrLf
    sql = sql & "   SELECT " & cInSQLString & vbCrLf
    sql = sql & "   FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
    sql = sql & "   WHERE FIINDT = TO_DATE('" & vDate & "','yyyy/mm/dd hh24:mi:ss')" & vbCrLf
    sql = sql & "     AND FISEQN = " & gdDBS.ColumnDataSet(vSeqNo, vEnd:=True) & vbCrLf
    sql = sql & "   )" & vbCrLf
'z 2006/06/13 èdï°ÉfÅ[É^éûÇÃèCê≥
'z    sql = sql & "   AND FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & "   AND FIRKBN = " & vSeqNo & vbCrLf
'//ñæç◊ÇÕÇrÇdÇpèáÇ…ÅFéÜÇ∆ÇÃìÀçáÇπÇ™ÇµÇ…Ç≠Ç¢ÅI
#If DETAIL_SEQN_ORDER = True Then
    sql = sql & " ORDER BY FIINDT,FISEQN" & vbCrLf
#Else
    sql = sql & " ORDER BY " & cSQLOrderString & vbCrLf    'èCê≥ÅAÉGÉâÅ[ÅAåxçêÅAê≥èÌÇÃèá
    '//à»ç~ÇÃÇnÇqÇcÇdÇqãÂ
    Select Case cboSort.ListIndex
    Case eSort.eImportSeq
        sql = sql & ",FIINDT,FISEQN" & vbCrLf
    Case eSort.eKeiyakusha
        sql = sql & ",FIITKB,FIKYCD,FIKSCD,FIPGNO,FIFKDT,FIHGCD,FISEQN" & vbCrLf
    Case Else
    End Select
#End If
    sql = sql & ")" & vbCrLf
    pMakeSQLReadDataDetail = sql
End Function

Private Sub cmdErrList_Click()
    If True = pSpreadCheckAndUpdate(sprTotal.Tag = mSprTotal.RowEdit Or sprDetail.Tag = mSprDetail.RowEdit) Then
        Exit Sub
    End If
    Dim reg As New RegistryClass
    Dim sql As String
    Load rptFurikaeYoteiImport
    With rptFurikaeYoteiImport
        .lblSort.Caption = "ï\é¶èáÅF " & cboSort.Text
        .documentName = mCaption
        '//çüèàÇ≈ê›íËÇÇµÇƒÇ‡ïœçXÇ≈Ç´Ç»Ç¢ÅI
        '.PageSettings.PaperSize = vbPRPSA4
        '.PageSettings.Orientation = ddOPortrait
        .adoData.ConnectionString = "Provider=OraOLEDB.Oracle.1;Password=" & reg.DbPassword & _
                                    ";Persist Security Info=True;User ID=" & reg.DbUserName & _
                                                           ";Data Source=" & reg.DbDatabaseName
        sql = "SELECT * FROM (" & vbCrLf
        sql = sql & "SELECT " & vbCrLf
#If SHORT_MSG Then
        sql = sql & " DECODE(FIERROR,-3,'éÊçû',-2,'èCê≥',-1,'àŸèÌ',0,'ê≥èÌ',1,'åxçê','ó·äO') as FIERRNM," & vbCrLf
#Else
        sql = sql & " CASE WHEN FIERROR = -2 THEN " & gdDBS.ColumnDataSet(cEditDataMsg, vEnd:=True) & vbCrLf
        sql = sql & "      WHEN FIERROR = -3 THEN " & gdDBS.ColumnDataSet(cImportMsg, vEnd:=True) & vbCrLf
'//2006/06/16 ñæç◊çÌèúëŒâû
        sql = sql & "      WHEN FIERROR = -4 THEN " & gdDBS.ColumnDataSet(cDeleteMsg, vEnd:=True) & vbCrLf
        sql = sql & "      WHEN FIERROR IN(-1,+0,+1) THEN " & vbCrLf
        sql = sql & "           DECODE(FIERROR," & vbCrLf
        sql = sql & "               -1,'àŸèÌ'," & vbCrLf
        sql = sql & "               +0,'ê≥èÌ'," & vbCrLf
        sql = sql & "               +1,'åxçê'," & vbCrLf
        sql = sql & "               NULL" & vbCrLf
        sql = sql & "           ) || ' => ' || " & vbCrLf
        sql = sql & "       DECODE(FIOKFG," & vbCrLf
        sql = sql & "               " & mYimp.updInvalid & ",'" & mYimp.mUpdateMessage(mYimp.updInvalid) & "'," & vbCrLf
        sql = sql & "               " & mYimp.updWarnErr & ",'" & mYimp.mUpdateMessage(mYimp.updWarnErr) & "'," & vbCrLf
        sql = sql & "               " & mYimp.updNormal & ",'" & mYimp.mUpdateMessage(mYimp.updNormal) & "'," & vbCrLf
        sql = sql & "               " & mYimp.updWarnUpd & ",'" & mYimp.mUpdateMessage(mYimp.updWarnUpd) & "'," & vbCrLf
        '//ÇªÇÒÇ»ÉfÅ[É^ÇÕñ≥Ç¢
        'sql = sql & "               " & mYimp.updResetCancel & ",'" & mYimp.mUpdateMessage(mYimp.updResetCancel) & "'," & vbCrLf
        sql = sql & "               'èàóùåãâ Ç™ì¡íËÇ≈Ç´Ç‹ÇπÇÒÅB'" & vbCrLf
        sql = sql & "           )" & vbCrLf
        sql = sql & "      ELSE                             'ó·äO => èàóùåãâ Ç™ì¡íËÇ≈Ç´Ç‹ÇπÇÒÅB'" & vbCrLf
        sql = sql & " END as FIERRNM," & vbCrLf
#End If
        sql = sql & " FIRKBN,TO_CHAR(FIINDT,'yyyy/mm/dd hh24:mi:ss') FIINDT,FISEQN,"
        sql = sql & " TO_CHAR(TO_DATE(FIFKDT,'yyyymmdd'),'yyyy/mm/dd') fifkdt," & vbCrLf
        sql = sql & "(SELECT ABITCD " & vbCrLf
        sql = sql & " FROM taItakushaMaster b " & vbCrLf
        sql = sql & " WHERE a.FIITKB = b.ABITKB" & vbCrLf
        sql = sql & " ) ABITCD," & vbCrLf
        sql = sql & " FIKYCD,FIKSCD,FIPGNO,FIHGCD," & vbCrLf
        sql = sql & " DECODE(NVL(FIKYFG,0),0,FIHKKG,DECODE(NVL(FIHKKG,0),0,NULL,FIHKKG)) FIHKKG," & vbCrLf
        sql = sql & " DECODE(NVL(FIKYFG,0),0,NULL,'âñÒ') FIKYFG," & vbCrLf
        sql = sql & " FIHKCT,FIKYCT," & vbCrLf
        sql = sql & " FIITKB || FIKYCD || FIKSCD || FIPGNO || FIFKDT FIGROUP," & vbCrLf
        sql = sql & mYimp.StatusColumns("," & vbCrLf, Len("," & vbCrLf))
        sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
        sql = sql & " WHERE FIINDT = TO_DATE('" & cboImpDate.Text & "','yyyy/mm/dd hh24:mi:ss') " & vbCrLf
        sql = sql & "   AND       (" & cInSQLString & ") IN(" & vbCrLf
        sql = sql & "       SELECT " & cInSQLString & vbCrLf
        sql = sql & "       FROM " & mYimp.TfFurikaeImport & " b " & vbCrLf
        sql = sql & "       WHERE a.FIINDT = b.FIINDT" & vbCrLf
        sql = sql & "         AND b.FIERROR <> " & mYimp.errNormal & vbCrLf
        sql = sql & "      )" & vbCrLf
        '//à»ç~ÇÃÇnÇqÇcÇdÇqãÂ
        sql = sql & " ORDER BY " & cSQLOrderString & vbCrLf    'èCê≥ÅAÉGÉâÅ[ÅAåxçêÅAê≥èÌÇÃèá
        Select Case cboSort.ListIndex
        Case eSort.eImportSeq
            sql = sql & " ,FIINDT,FISEQN" & vbCrLf
        Case eSort.eKeiyakusha
            'sql = sql & " ORDER BY FIINDT,FIITKB,FIKYCD,FIKSCD,FIPGNO,DECODE(FIRKBN,-1,999,FIRKBN),FISEQN" & vbCrLf
            sql = sql & " ,FIINDT,FIITKB,FIKYCD,FIKSCD,FIPGNO,FIFKDT,FIHGCD,FISEQN" & vbCrLf
        Case Else
        End Select
        sql = sql & ")"
        .adoData.Source = sql
        Call .adoData.Refresh
'        .mTotalCnt = .adoData.Recordset.RecordCount
        Call .Show
    End With
End Sub

Private Sub cmdImport_Click()
    If True = pSpreadCheckAndUpdate(sprTotal.Tag = mSprTotal.RowEdit Or sprDetail.Tag = mSprDetail.RowEdit) Then
        Exit Sub
    End If
    '//É{É^ÉìÇÃÉRÉìÉgÉçÅ[Éã
    If -1 <> pAbortButton(cmdImport, cBtnImport) Then
        Exit Sub
    End If
    cmdImport.Caption = cBtnCancel
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(False, cmdImport)

    Dim file As New FileClass
    
    dlgFile.DialogTitle = "ÉtÉ@ÉCÉãÇäJÇ≠(" & mCaption & ")"
    dlgFile.FileName = mReg.InputFileName(mCaption)
    If IsEmpty(file.OpenDialog(dlgFile)) Then
        GoTo cmdImport_ClickAbort:
        Exit Sub
    End If
    '//êUçûó\íËï\ÉfÅ[É^ÇÉCÉìÉ|Å[Ég
    Dim FurikaeDetail As tpFurikaeDetail
    Dim FurikaeTotal  As tpFurikaeTotal
    Dim fp As Integer
    Dim ms As New MouseClass
    Call ms.Start
    
    fp = FreeFile
    Open dlgFile.FileName For Random Access Read As #fp Len = Len(FurikaeDetail)
    fraProgressBar.Visible = True
    pgrProgressBar.Max = LOF(fp) / Len(FurikaeDetail)
    '//ÉtÉ@ÉCÉãÉTÉCÉYÇ™à·Ç§èÍçáÇÃåxçêÉÅÉbÉZÅ[ÉW
    If pgrProgressBar.Max <> Int(pgrProgressBar.Max) Then
        If (LOF(fp) - 1) / Len(FurikaeDetail) <> Int((LOF(fp) - 1) / Len(FurikaeDetail)) Then
            '/èàóùë±çsÇ∑ÇÈÇ∆ÇcÇaÇ™Ç®Ç©ÇµÇ≠Ç»ÇÈÇÃÇ≈íÜé~Ç∑ÇÈ
            Close #fp
            Call gdDBS.MsgBox("éwíËÇ≥ÇÍÇΩÉtÉ@ÉCÉã(" & dlgFile.FileName & ")Ç™àŸèÌÇ≈Ç∑ÅB" & vbCrLf & vbCrLf & "èàóùÇë±çsèoóàÇ‹ÇπÇÒÅB", vbCritical + vbOKOnly, mCaption)
            GoTo cmdImport_ClickAbort
            Exit Sub
        End If
    End If

    On Error GoTo cmdImport_ClickError
        
    Call gdDBS.AutoLogOut(mCaption, "éÊçûèàóùÇ™äJénÇ≥ÇÍÇ‹ÇµÇΩÅB")
    
#If ORA_DEBUG = 1 Then
    Dim sql As String, insDate As String, dyn As OraDynaset
#Else
    Dim sql As String, insDate As String, dyn As Object
#End If
    Dim updCnt As Long, insCnt As Long, recCnt As Long
    
'//2006/06/16 å_ñÒé“î‘çÜñ≥ÇµÇÃÉpÉìÉ`ÉfÅ[É^ëŒâû
    Dim BadNo As Long
    BadNo = cFIKYCD_BadStart
    
    insDate = gdDBS.sysDate()
    
    Call gdDBS.Database.BeginTrans
    '///////////////////////////////////////////////
    '//ÉVÅ[ÉPÉìÉXÇÇPî‘Ç©ÇÁÇ…ÉäÉZÉbÉg
    sql = "declare begin ResetSequence('sqImportSeq',1); end;"
    Call gdDBS.Database.ExecuteSQL(sql)
    
    Do While Loc(fp) < LOF(fp) / Len(FurikaeDetail)
        DoEvents
        If mAbort Then
            GoTo cmdImport_ClickError
        End If
        Get #fp, , FurikaeDetail
        recCnt = Loc(fp)
'//2006/06/16 å_ñÒé“î‘çÜñ≥ÇµÇÃÉpÉìÉ`ÉfÅ[É^ëŒâû
        If "" = Trim(FurikaeDetail.KeiyakuNo) Then
            FurikaeDetail.KeiyakuNo = BadNo
        End If
        If "" = Trim(FurikaeDetail.KyoshitsuNo) Then
            FurikaeDetail.KyoshitsuNo = "000"       '//ì¸óÕÇè»ÇØÇ»Ç¢ÇÊÇ§Ç…ÇÌÇ¥Ç∆ "000"
        End If
        If "" = Trim(FurikaeDetail.PageNumber) Then
            FurikaeDetail.PageNumber = "00"         '//ì¸óÕÇè»ÇØÇ»Ç¢ÇÊÇ§Ç…ÇÌÇ¥Ç∆ "00"
        End If
'//2006/05/17 êUë÷ó\íËì˙ÇÃñ≥Ç¢ÉfÅ[É^Ç™Ç†ÇÈÇΩÇﬂÉTÅ[ÉoÅ[ÇÃñ{ì˙Çê›íËÇ∑ÇÈ
        If "" = Trim(FurikaeDetail.FurikaeDate) Then
            FurikaeDetail.FurikaeDate = Format(insDate, "yyyymmdd")
        End If
        If FurikaeDetail.CancelFlag = mYimp.TotalTextKubun Then
'//2006/06/16 å_ñÒé“î‘çÜñ≥ÇµÇÃÉpÉìÉ`ÉfÅ[É^ëŒâûÅFÉgÅ[É^ÉãÉåÉRÅ[ÉhéûÇ…î‘çÜâ¡éZ
            BadNo = BadNo + 1
            '//ÉgÅ[É^ÉãÉåÉRÅ[ÉhÇ»ÇÃÇ≈ÉRÉsÅ[
            LSet FurikaeTotal = FurikaeDetail
        End If
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = _
            "écÇË" & Right(String(7, " ") & Format(pgrProgressBar.Max - Loc(fp), "#,##0"), 7) & " åè"
        pgrProgressBar.Value = IIf(Loc(fp) <= pgrProgressBar.Max, Loc(fp), pgrProgressBar.Max)
        sql = "SELECT FIMCDT"
        sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
        sql = sql & " WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(insDate, vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss')" & vbCrLf
        sql = sql & "   AND FISEQN > 0" & vbCrLf
        sql = sql & "   AND FIKYCD = " & gdDBS.ColumnDataSet(FurikaeDetail.KeiyakuNo, vEnd:=True) & vbCrLf
        sql = sql & "   AND FIKSCD = " & gdDBS.ColumnDataSet(FurikaeDetail.KyoshitsuNo, vEnd:=True) & vbCrLf
        sql = sql & "   AND FIPGNO = " & gdDBS.ColumnDataSet(FurikaeDetail.PageNumber, "I", vEnd:=True) & vbCrLf
        sql = sql & "   AND FIFKDT = " & gdDBS.ColumnDataSet(FurikaeDetail.FurikaeDate, "L", vEnd:=True) & vbCrLf
        If FurikaeDetail.CancelFlag = mYimp.TotalTextKubun Then
            sql = sql & " AND FIRKBN = " & gdDBS.ColumnDataSet(mYimp.RecordIsTotal, "I", vEnd:=True) & vbCrLf    '//ÉåÉRÅ[ÉhãÊï™
        Else
            sql = sql & " AND FIRKBN <> " & gdDBS.ColumnDataSet(mYimp.RecordIsTotal, "I", vEnd:=True) & vbCrLf      '//ÉåÉRÅ[ÉhãÊï™
            sql = sql & " AND FIHGCD = " & gdDBS.ColumnDataSet(FurikaeDetail.HogoshaNo, vEnd:=True) & vbCrLf
        End If
#If ORA_DEBUG = 1 Then
        Set dyn = gdDBS.OpenRecordset(sql, dynOption.ORADYN_READONLY)
#Else
        Set dyn = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
#End If
        If Not dyn.EOF Then
'//2006/04/27 ÉfÅ[É^åèêîÇê≥ämÇ…Ç∑ÇÈÇΩÇﬂÇ…Ç∆Ç…Ç©Ç≠ÉfÅ[É^Ç™Ç†ÇÍÇŒçXêVÇ∑ÇÈ
            '//çXêVÇééÇ›ÇÈÅFìØàÍÉeÉLÉXÉgì‡Ç…ìØÇ∂ÉfÅ[É^Ç™Ç†ÇÈÅH
            sql = "UPDATE " & mYimp.TfFurikaeImport & " SET " & vbCrLf
            '//éùçûì˙Ç™å„ì˙Ç»ÇÁçXêVÅFDetail ÅA Total Ç«ÇøÇÁÇ≈Ç‡ÇnÇj
            If Val(dyn.Fields("FIMCDT")) < Val(FurikaeDetail.MochikomiBi) Then
        
                If FurikaeDetail.CancelFlag = mYimp.TotalTextKubun Then
                    sql = sql & "FIHKCT = " & gdDBS.ColumnDataSet(gdDBS.Nz(FurikaeTotal.DetailCnt, 0), "I") & vbCrLf
                    sql = sql & "FIKYCT = " & gdDBS.ColumnDataSet(gdDBS.Nz(FurikaeTotal.CancelCnt, 0), "I") & vbCrLf
                    sql = sql & "FIHKKG = " & gdDBS.ColumnDataSet(gdDBS.Nz(FurikaeTotal.DetailGaku, 0), "L") & vbCrLf
                Else
'//2006/04/27 å˚ç¿ñºã`êlñºçÄñ⁄í«â¡ÅFëSäpÉXÉyÅ[ÉXÇîºäpÉXÉyÅ[ÉXÇ…ïœä∑
                    sql = sql & "FIKZNM = " & gdDBS.ColumnDataSet(Replace(FurikaeDetail.KouzaName, "Å@", " ")) & vbCrLf
                    sql = sql & "FIHKKG = " & gdDBS.ColumnDataSet(gdDBS.Nz(FurikaeDetail.HenkouGaku, 0), "L") & vbCrLf
                    '//ÉLÉÉÉìÉZÉãÉtÉâÉO BLANK Ç†ÇË
                    sql = sql & "FIKYFG = " & gdDBS.ColumnDataSet(gdDBS.Nz(FurikaeDetail.CancelFlag, 0), "I") & vbCrLf
                End If
                sql = sql & "FIERROR = " & gdDBS.ColumnDataSet(mYimp.errImport) & vbCrLf
                sql = sql & "FIMCDT = " & gdDBS.ColumnDataSet(FurikaeDetail.MochikomiBi, "L") & vbCrLf
            '//éùçûì˙Ç™ëOì˙Ç»ÇÁçXêVåèêîÇÃÇ›çXêVÅFDetail ÅA Total Ç«ÇøÇÁÇ≈Ç‡ÇnÇj
            End If
'//2006/04/27 ÇPÉtÉ@ÉCÉãíÜÇÃéÊçûâÒêîÅFï°êîë∂ç›Ç∑ÇÈ
            sql = sql & "FIICNT = FIICNT + 1," & vbCrLf
            sql = sql & "FIUPDT = SYSDATE" & vbCrLf
            sql = sql & " WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(insDate, vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss')" & vbCrLf
            sql = sql & "   AND FISEQN > 0" & vbCrLf
            sql = sql & "   AND FIKYCD = " & gdDBS.ColumnDataSet(FurikaeDetail.KeiyakuNo, vEnd:=True) & vbCrLf
            sql = sql & "   AND FIKSCD = " & gdDBS.ColumnDataSet(FurikaeDetail.KyoshitsuNo, vEnd:=True) & vbCrLf
            sql = sql & "   AND FIPGNO = " & gdDBS.ColumnDataSet(FurikaeDetail.PageNumber, "I", vEnd:=True) & vbCrLf
            sql = sql & "   AND FIFKDT = " & gdDBS.ColumnDataSet(FurikaeDetail.FurikaeDate, "L", vEnd:=True) & vbCrLf
            If FurikaeDetail.CancelFlag = mYimp.TotalTextKubun Then
                sql = sql & " AND FIRKBN = " & gdDBS.ColumnDataSet(mYimp.RecordIsTotal, "I", vEnd:=True) & vbCrLf    '//ÉåÉRÅ[ÉhãÊï™
            Else
                sql = sql & " AND FIRKBN <> " & gdDBS.ColumnDataSet(mYimp.RecordIsTotal, "I", vEnd:=True) & vbCrLf      '//ÉåÉRÅ[ÉhãÊï™
                sql = sql & " AND FIHGCD = " & gdDBS.ColumnDataSet(FurikaeDetail.HogoshaNo, vEnd:=True) & vbCrLf
            End If
            Call gdDBS.Database.ExecuteSQL(sql)
            updCnt = updCnt + 1&
        Else
            insCnt = insCnt + 1&
            '//çXêVÇ≈Ç´Ç»Ç©Ç¡ÇΩÇÃÇ≈ë}ì¸ÇééÇ›ÇÈ
            '//ÉfÅ[É^ÇÉeÅ[ÉuÉãÇ…ë}ì¸
            sql = "INSERT INTO " & mYimp.TfFurikaeImport & "(" & vbCrLf
            sql = sql & "FIINDT,"   '//A=  éÊçûì˙
            sql = sql & "FISEQN,"   '//A=  éÊçûSEQNO
            sql = sql & "FIITKB,"   '//A=  àœëıé“ãÊï™
            sql = sql & "FIKYCD,"   '//A=  å_ñÒé“î‘çÜ
            sql = sql & "FIKSCD,"   '//A=  ã≥é∫î‘çÜ
            sql = sql & "FIPGNO,"   '//A=  ÉyÅ[ÉWî‘çÜ
            sql = sql & "FIFKDT,"   '//A=  êUë÷ì˙
            sql = sql & "FIRKBN,"   '//B/T=ÉåÉRÅ[ÉhãÊï™ ÇOÅÅñæç◊ÅAÇPÅÅçáåv
            sql = sql & "FIHKCT,"   '//  T=ïœçXåèêî
            sql = sql & "FIKYCT,"   '//  T=âñÒåèêî
            sql = sql & "FIHGCD,"   '//B=  ï€åÏé“î‘çÜ
'//2006/04/27 å˚ç¿ñºã`êlñºçÄñ⁄í«â¡
            sql = sql & "FIKZNM,"   '//  T=ï€åÏé“ÅEå˚ç¿ñºã`êlñº
            sql = sql & "FIHKKG,"   '//B/T=ïœçXå„ã‡äz
            sql = sql & "FIKYFG,"   '//B=  âñÒÉtÉâÉO
            sql = sql & "FIERROR,"
            sql = sql & "FIMCDT,"   '//éùçûì˙
'//2006/04/27 ÇPÉtÉ@ÉCÉãíÜÇÃéÊçûâÒêîÅFï°êîë∂ç›Ç∑ÇÈ
            sql = sql & "FIICNT," & vbCrLf
            sql = sql & "FIUSID,"   '//A=  çXêVé“
            sql = sql & "FIUPDT,"   '//A=  çXêVì˙
            sql = sql & "FIOKFG " & vbCrLf  '//éÊçûÇnÇjÉtÉâÉO
            sql = sql & ")VALUES(" & vbCrLf
            sql = sql & "TO_DATE(" & gdDBS.ColumnDataSet(insDate, vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss')," & vbCrLf
            sql = sql & "sqImportSeq.NEXTVAL," & vbCrLf
'//2006/06/16 å_ñÒé“î‘çÜñ≥ÇµÇÃÉpÉìÉ`ÉfÅ[É^ëŒâû
'//            sql = sql & "(SELECT ABITKB FROM taItakushaMaster WHERE ABKYTP = '" & Left(FurikaeDetail.KeiyakuNo, 1) & "')," & vbCrLf
            sql = sql & "(SELECT DECODE(MAX(ABITKB),NULL,'" & cFIITKB_BadCode & "',MAX(ABITKB)) FROM taItakushaMaster WHERE ABKYTP = '" & Left(FurikaeDetail.KeiyakuNo, 1) & "')," & vbCrLf
            sql = sql & gdDBS.ColumnDataSet(FurikaeDetail.KeiyakuNo) & vbCrLf
            sql = sql & gdDBS.ColumnDataSet(FurikaeDetail.KyoshitsuNo) & vbCrLf
            sql = sql & gdDBS.ColumnDataSet(FurikaeDetail.PageNumber, "I") & vbCrLf
            sql = sql & gdDBS.ColumnDataSet(FurikaeDetail.FurikaeDate, "L") & vbCrLf
            If FurikaeDetail.CancelFlag = mYimp.TotalTextKubun Then
                sql = sql & gdDBS.ColumnDataSet(mYimp.RecordIsTotal, "I") & vbCrLf    '//ÉåÉRÅ[ÉhãÊï™
                sql = sql & gdDBS.ColumnDataSet(gdDBS.Nz(FurikaeTotal.DetailCnt, 0), "I") & vbCrLf
                sql = sql & gdDBS.ColumnDataSet(gdDBS.Nz(FurikaeTotal.CancelCnt, 0), "I") & vbCrLf
                sql = sql & "NULL," & vbCrLf
'//2006/04/27 å˚ç¿ñºã`êlñºçÄñ⁄í«â¡
                sql = sql & "NULL," & vbCrLf
                sql = sql & gdDBS.ColumnDataSet(gdDBS.Nz(FurikaeTotal.DetailGaku, 0), "L") & vbCrLf
                sql = sql & "NULL," & vbCrLf
            Else
                sql = sql & "0," & vbCrLf     '//ÉåÉRÅ[ÉhãÊï™ÅFå„Ç≈êeÇÃÇrÇdÇpÇë„ì¸Ç∑ÇÈ.
                sql = sql & "NULL," & vbCrLf
                sql = sql & "NULL," & vbCrLf
                sql = sql & gdDBS.ColumnDataSet(FurikaeDetail.HogoshaNo) & vbCrLf
'//2006/04/27 å˚ç¿ñºã`êlñºçÄñ⁄í«â¡ÅFëSäpÉXÉyÅ[ÉXÇîºäpÉXÉyÅ[ÉXÇ…ïœä∑
                sql = sql & gdDBS.ColumnDataSet(Replace(FurikaeDetail.KouzaName, "Å@", " ")) & vbCrLf
                sql = sql & gdDBS.ColumnDataSet(gdDBS.Nz(FurikaeDetail.HenkouGaku, 0), "L") & vbCrLf
                '//ÉLÉÉÉìÉZÉãÉtÉâÉO BLANK Ç†ÇË
                sql = sql & gdDBS.ColumnDataSet(gdDBS.Nz(FurikaeDetail.CancelFlag, 0), "I") & vbCrLf
            End If
            sql = sql & gdDBS.ColumnDataSet(mYimp.errImport) & vbCrLf
            sql = sql & gdDBS.ColumnDataSet(FurikaeDetail.MochikomiBi, "L") & vbCrLf
'//ÇPÉtÉ@ÉCÉãíÜÇÃéÊçûâÒêîÅFï°êîë∂ç›Ç∑ÇÈ
            sql = sql & " 1," & vbCrLf
            sql = sql & gdDBS.ColumnDataSet(gdDBS.LoginUserName)
            sql = sql & "SYSDATE,"
            sql = sql & gdDBS.ColumnDataSet(mYimp.updNormal, "I", vEnd:=True)
            sql = sql & ")"
            Call gdDBS.Database.ExecuteSQL(sql)
        End If
        Call dyn.Close
        Set dyn = Nothing
    Loop
    Close #fp
    sql = "UPDATE " & mYimp.TfFurikaeImport & " a SET " & vbCrLf
    sql = sql & " FIRKBN = (" & vbCrLf
    sql = sql & "     SELECT FISEQN FROM " & mYimp.TfFurikaeImport & " b " & vbCrLf
    sql = sql & "     WHERE b.FIINDT = a.FIINDT" & vbCrLf
    sql = sql & "       AND b.FIKYCD = a.FIKYCD" & vbCrLf
    sql = sql & "       AND b.FIKSCD = a.FIKSCD" & vbCrLf
    sql = sql & "       AND b.FIPGNO = a.FIPGNO" & vbCrLf
    sql = sql & "       AND b.FIFKDT = a.FIFKDT" & vbCrLf
    sql = sql & "       AND b.FIRKBN = " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & "     )" & vbCrLf
    sql = sql & " WHERE a.FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(insDate, vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss')" & vbCrLf
    sql = sql & "   AND a.FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf
    Call gdDBS.Database.ExecuteSQL(sql)
     '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
    stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "éÊçûäÆóπ(" & recCnt & "åè)"
    pgrProgressBar.Value = pgrProgressBar.Max
   '//êUçûó\íËï\ÉfÅ[É^ÇÃà íuÇÉåÉWÉXÉgÉäÇ…ï€ä«
    mReg.InputFileName(mCaption) = dlgFile.FileName
    '//éÊçûÉfÅ[É^ÇÃÉoÉbÉNÉAÉbÉv
    Call gBackupTextData(dlgFile.FileName)

    Call gdDBS.Database.CommitTrans
    
    Call gdDBS.AutoLogOut(mCaption, "éÊçûì˙éû=[" & insDate & "]Ç≈ " & recCnt & " åèÅií«â¡=" & insCnt & " / èdï°=" & updCnt & "ÅjÇÃÉfÅ[É^Ç™éÊÇËçûÇ‹ÇÍÇ‹ÇµÇΩÅB")
    
    '//éÊçûåãâ ÇÉRÉìÉ{É{ÉbÉNÉXÇ…ÉZÉbÉg
    Call pMakeComboBox

cmdImport_ClickAbort:
    '//Ç∑Ç◊ÇƒÇÃíËã`ÇÉäÉZÉbÉg
    Set file = Nothing
    Set ms = Nothing
    cmdImport.Caption = cBtnImport
    fraProgressBar.Visible = False
    Call pLockedControl(True)
    Exit Sub
cmdImport_ClickError:
    '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
    'cmdImport.Caption = cBtnImport
    Call gdDBS.Database.Rollback
    Call gdDBS.ErrorCheck       '//ÉGÉâÅ[ÉgÉâÉbÉv
    If Err Then
        Dim errCode As Integer, errMsg As String
        If gdDBS.Database.LastServerErr Then
            errCode = gdDBS.Database.LastServerErr
            errMsg = gdDBS.Database.LastServerErrText
        Else
            errCode = Err
            errMsg = Error
        End If
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "éÊçûÉGÉâÅ[(" & errCode & ")"
        Call gdDBS.AutoLogOut(mCaption, recCnt & "åèñ⁄Ç≈ÉGÉâÅ[Ç™î≠ê∂ÇµÇΩÇΩÇﬂéÊçûèàóùÇÕíÜé~Ç≥ÇÍÇ‹ÇµÇΩÅB(Error=" & errMsg & ")")
    Else
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "éÊçûíÜíf"
        Call gdDBS.AutoLogOut(mCaption, "éÊçûèàóùÇÕíÜé~Ç≥ÇÍÇ‹ÇµÇΩÅB")
    End If
    'Call pLockedControl(True)
    GoTo cmdImport_ClickAbort:
End Sub

Private Sub pMakeComboBox()
    Dim ms As New MouseClass
    Call ms.Start
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(False)
'    Dim sql As String, dyn As OraDynaset, MaxDay As Variant
    Dim sql As String, dyn As Object, MaxDay As Variant
    sql = "SELECT DISTINCT TO_CHAR(FIINDT,'yyyy/mm/dd hh24:mi:ss') FIINDT_A"
    sql = sql & " FROM " & mYimp.TfFurikaeImport
    sql = sql & " ORDER BY FIINDT_A"
    Set dyn = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
    Call cboImpDate.Clear
    Do Until dyn.EOF()
        Call cboImpDate.AddItem(dyn.Fields("FIINDT_A"))
        'cboImpDate.ItemData(cboImpDate.NewIndex) = dyn.Fields("CIINDT_B")
        Call dyn.MoveNext
    Loop
    Call dyn.Close
    If cboImpDate.ListCount Then
        cboImpDate.ListIndex = cboImpDate.ListCount - 1
    Else
        sprTotal.MaxRows = 0
    End If
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(True)
End Sub
        
Private Sub pUpdateDetail()
'//íçà”ÅI
'// mSprDetail/mSprTotal & eSprDetail/eSprTotal ÇÃç\ï∂Ç™éóÇƒÇ¢ÇÈÇÃÇ≈íçà”
    Dim sql As String
    Dim Row As Long
    For Row = 1 To sprDetail.MaxRows
        If Val(mSprDetail.Value(eSprDetail.eEditFlag, Row)) = mSprDetail.RowEdit Then
            sql = "UPDATE " & mYimp.TfFurikaeImport & " SET " & vbCrLf
            sql = sql & "FIERROR = " & gdDBS.ColumnDataSet(mSprDetail.Value(eSprDetail.eErrorFlag, Row), "I") & vbCrLf
            sql = sql & "FIHGCD  = " & gdDBS.ColumnDataSet(mSprDetail.Value(eSprDetail.eHogoshaNo, Row)) & vbCrLf
'//2006/04/27 å˚ç¿ñºã`êlñºçÄñ⁄í«â¡
            sql = sql & "FIKZNM  = " & gdDBS.ColumnDataSet(mSprDetail.Value(eSprDetail.eImportKouza, Row)) & vbCrLf
'//2006/04/26 ã‡äzÇ»ÇÃÇ≈ NULL Ç≈ÇÕñ≥Ç≠ ÅuÇOÅvÇë„ì¸Ç∑ÇÈ
            sql = sql & "FIHKKG  = " & gdDBS.ColumnDataSet(gdDBS.Nz(mSprDetail.Value(eSprDetail.eHenkoGaku, Row), 0), "L") & vbCrLf
            sql = sql & "FIKYFG  = " & gdDBS.ColumnDataSet(mSprDetail.Value(eSprDetail.eCancelFlag, Row), "I") & vbCrLf
            sql = sql & "FIUSID  = " & gdDBS.ColumnDataSet(gdDBS.LoginUserName) & vbCrLf
            sql = sql & "FIUPDT  = SYSDATE" & vbCrLf
            sql = sql & " WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(mSprDetail.Value(eSprDetail.eImpDate, Row), vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss') " & vbCrLf
            sql = sql & "   AND FISEQN = " & gdDBS.ColumnDataSet(mSprDetail.Value(eSprDetail.eImpSEQ, Row), "L", vEnd:=True) & vbCrLf
            Call gdDBS.Database.ExecuteSQL(sql)
            '//èCê≥ÉtÉâÉOÉäÉZÉbÉg
            mSprDetail.Value(eSprDetail.eEditFlag, Row) = mSprDetail.RowNonEdit
        End If
    Next Row
    sprDetail.Tag = mSprDetail.RowNonEdit
End Sub

Private Sub pUpdateTotal()
    Dim sql As String, updCnt As Long
    Dim Row As Long
    
    For Row = 1 To sprTotal.MaxRows
        If Val(mSprTotal.Value(eSprTotal.eEditFlag, Row)) = mSprTotal.RowEdit _
        Or Val(mSprTotal.Value(eSprTotal.eEditFlag, Row)) = mSprTotal.RowEditHeader Then
            '//çáåvçsÇÃçXêV
            sql = "UPDATE " & mYimp.TfFurikaeImport & " SET " & vbCrLf
            sql = sql & "FIERROR = " & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eErrorFlag, Row), "I") & vbCrLf
'//2006/04/26 åèêîÅAã‡äzÇ»ÇÃÇ≈ NULL Ç≈ÇÕñ≥Ç≠ ÅuÇOÅvÇë„ì¸Ç∑ÇÈ
            sql = sql & "FIHKCT  = " & gdDBS.ColumnDataSet(gdDBS.Nz(mSprTotal.Value(eSprTotal.eHenkoCount, Row), 0), "I") & vbCrLf
            sql = sql & "FIHKKG  = " & gdDBS.ColumnDataSet(gdDBS.Nz(mSprTotal.Value(eSprTotal.eHenkoKingaku, Row), 0), "L") & vbCrLf
            sql = sql & "FIKYCT  = " & gdDBS.ColumnDataSet(gdDBS.Nz(mSprTotal.Value(eSprTotal.eCancelCount, Row), 0), "I") & vbCrLf
            sql = sql & "FIUSID  = " & gdDBS.ColumnDataSet(gdDBS.LoginUserName) & vbCrLf
            sql = sql & "FIUPDT  = SYSDATE" & vbCrLf
            sql = sql & " WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eImpDate, Row), vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss') " & vbCrLf
            sql = sql & "   AND FISEQN = " & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eImpSEQ, Row), "L", vEnd:=True) & vbCrLf
            updCnt = gdDBS.Database.ExecuteSQL(sql)
            '//çáåvçsÇ…ä÷òAÇµÇΩñæç◊çsÇÃçXêV
            If Val(mSprTotal.Value(eSprTotal.eEditFlag, Row)) = mSprTotal.RowEditHeader Then
                sql = "UPDATE " & mYimp.TfFurikaeImport & " SET " & vbCrLf
                sql = sql & "FIERROR = " & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eErrorFlag, Row), "I") & vbCrLf
                sql = sql & "FIITKB  = " & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eItakuCode, Row)) & vbCrLf
                sql = sql & "FIKYCD  = " & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eKeiyakuCode, Row)) & vbCrLf
                sql = sql & "FIKSCD  = " & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eKyoshitsuNo, Row)) & vbCrLf
                sql = sql & "FIPGNO  = " & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.ePageNumber, Row), "I") & vbCrLf
                '//Åuyyyy/mm/ddÅvÇ≈ì¸óÕÇµÇƒÇ¢ÇÈÇÃÇ≈ yyyymmdd Ç…ïœä∑Åïì˙ïtÇÃêÆçáê´É`ÉFÉbÉN
                sql = sql & "FIFKDT  = TO_CHAR(TO_DATE(" & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eFirukaeDate, Row), vEnd:=True) & ",'yyyy/mm/dd'),'yyyymmdd')," & vbCrLf
                sql = sql & "FIUSID  = " & gdDBS.ColumnDataSet(gdDBS.LoginUserName) & vbCrLf
                sql = sql & "FIUPDT  = SYSDATE" & vbCrLf
'z 2006/06/19 ñæç◊çsçXêVÇ…ÉoÉOÇ™Ç†ÇÈÇÃÇ≈ïœçXÅF FIRKBN ÇéQè∆Ç∑ÇÈ.
'z                sql = sql & " WHERE (" & cInSQLString & ") IN (" & vbCrLf
'z                sql = sql & "   SELECT " & cInSQLString & vbCrLf
'z                sql = sql & "   FROM " & mYimp.TfFurikaeImport & vbCrLf
'z                sql = sql & "   WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eImpDate, Row), vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss') " & vbCrLf
'z                sql = sql & "     AND FISEQN = " & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eImpSEQ, Row), "L", vEnd:=True) & vbCrLf
'z                sql = sql & "  )" & vbCrLf
                sql = sql & " WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eImpDate, Row), vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss') " & vbCrLf
                sql = sql & "   AND(FISEQN = " & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eImpSEQ, Row), "L", vEnd:=True) & vbCrLf
                sql = sql & "    OR FIRKBN = " & gdDBS.ColumnDataSet(mSprTotal.Value(eSprTotal.eImpSEQ, Row), "L", vEnd:=True) & vbCrLf
                sql = sql & "   )" & vbCrLf
                updCnt = gdDBS.Database.ExecuteSQL(sql)
            End If
            '//èCê≥ÉtÉâÉOÉäÉZÉbÉg
            mSprTotal.Value(eSprTotal.eEditFlag, Row) = mSprTotal.RowNonEdit
        End If
    Next Row
    sprTotal.Tag = mSprTotal.RowNonEdit
End Sub

Private Sub cmdSprUpdate_Click()
    If -1 <> pAbortButton(cmdSprUpdate, cBtnSprUpdate) Then
        Exit Sub
    End If
    cmdSprUpdate.Caption = cBtnCancel
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(False, cmdSprUpdate)
    Dim ms As New MouseClass
    Call ms.Start
    
    Call gdDBS.AutoLogOut(mCaption, "[" & cboImpDate.Text & "] ÇÃçXêVÇ™äJénÇ≥ÇÍÇ‹ÇµÇΩÅB")
    
'    On Error GoTo cmdSprUpdate_ClickError:
    Call gdDBS.Database.BeginTrans
    
    '//ñæç◊ÉåÉRÅ[ÉhÇÃçXêV
    If sprDetail.Tag = mSprDetail.RowEdit Then
        Call pUpdateDetail
    End If
    '//çáåvÉåÉRÅ[ÉhÇÃçXêV
    If sprTotal.Tag = mSprTotal.RowEdit Then
        Call pUpdateTotal
    End If
    Call gdDBS.Database.CommitTrans
    '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
    stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "çXêVäÆóπ"
    Call gdDBS.AutoLogOut(mCaption, "[" & cboImpDate.Text & "]  ÇÃçXêVÇ™äÆóπÇµÇ‹ÇµÇΩÅB")
    
    '//É{É^ÉìÇñﬂÇ∑
    cmdSprUpdate.Caption = cBtnSprUpdate
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(True)
    Exit Sub
cmdSprUpdate_ClickError:
    Call gdDBS.Database.Rollback
    If Err Then
        Dim errCode As Integer, errMsg As String
        If gdDBS.Database.LastServerErr Then
            errCode = gdDBS.Database.LastServerErr
            errMsg = gdDBS.Database.LastServerErrText
        Else
            errCode = Err
            errMsg = Error
        End If
        fraProgressBar.Visible = False
        '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "çXêVÉGÉâÅ[(" & errCode & ")"
        Call gdDBS.AutoLogOut(mCaption, "ÉGÉâÅ[Ç™î≠ê∂ÇµÇΩÇΩÇﬂçXêVÇÕíÜé~Ç≥ÇÍÇ‹ÇµÇΩÅB(Error=" & errMsg & ")")
        Call MsgBox("çXêVëŒè€ = [" & cboImpDate.Text & "]" & vbCrLf & _
                    "ÇÕÉGÉâÅ[Ç™î≠ê∂ÇµÇΩÇΩÇﬂçXêVÇÕíÜé~Ç≥ÇÍÇ‹ÇµÇΩÅB" & vbCrLf & errMsg, _
                vbOKOnly + vbCritical, mCaption)
    Else
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "çXêVíÜíf"
        Call gdDBS.AutoLogOut(mCaption, "[" & cboImpDate.Text & "] ÇÃçXêVÇÕíÜé~Ç≥ÇÍÇ‹ÇµÇΩÅB")
    End If
    '//É{É^ÉìÇñﬂÇ∑
    cmdUpdate.Caption = cBtnSprUpdate
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(True)
End Sub

Private Sub cmdUpdate_Click()
    If True = pSpreadCheckAndUpdate(sprTotal.Tag = mSprTotal.RowEdit Or sprDetail.Tag = mSprDetail.RowEdit) Then
        Exit Sub
    End If
    If -1 <> pAbortButton(cmdUpdate, cBtnUpdate) Then
        Exit Sub
    End If
    cmdUpdate.Caption = cBtnCancel
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(False, cmdUpdate)
    Dim ms As New MouseClass
    Call ms.Start
    
    Call gdDBS.AutoLogOut(mCaption, "[" & cboImpDate.Text & "] ÇÃÉ}ÉXÉ^îΩâfÇ™äJénÇ≥ÇÍÇ‹ÇµÇΩÅB")
    
    On Error GoTo cmdUpdate_ClickError:
    Call gdDBS.Database.BeginTrans
        
    '//âñÒì˙ÇÃê›íË
    Dim CanDate As String
    CanDate = gdDBS.SystemUpdate("AANXKZ")
    CanDate = Format(DateSerial(Val(Mid(CanDate, 1, 4)), Val(Mid(CanDate, 5, 2)), Val(Mid(CanDate, 7, 2)) - 1), "yyyymmdd")
    '//ÉVÉXÉeÉÄÉ}ÉXÉ^ÇÃéüâÒêUë÷ì˙(ï€åÏé“à∂)ÇÃëOì˙
    
#If ORA_DEBUG = 1 Then
    Dim sql As String, dyn As OraDynaset, recCnt As Long, updCnt As Long
#Else
    Dim sql As String, dyn As Object, recCnt As Long, updCnt As Long
#End If
    '//////////////////////////////////////////////////////////
    '//Ç±Ç±Ç≈égópÇ∑ÇÈã§í ÇÃ WHERE èåè
    Dim Condition As String
    Condition = Condition & " AND FIINDT = TO_DATE('" & cboImpDate.Text & "','yyyy/mm/dd hh24:mi:ss') " & vbCrLf
    '// ----------------------------------------------------------------->>>Å´Å´Å´Å´
    Condition = Condition & " AND       (" & cInSQLString & ") NOT IN(" & vbCrLf
    Condition = Condition & "     SELECT " & cInSQLString & vbCrLf
    Condition = Condition & "     FROM " & mYimp.TfFurikaeImport & " b " & vbCrLf
    Condition = Condition & "     WHERE a.FIINDT = b.FIINDT" & vbCrLf
    Condition = Condition & "       AND b.FIOKFG <> " & mYimp.updNormal & vbCrLf      '//ê≥èÌÇ≈Ç»Ç¢ÅFNOT IN
    Condition = Condition & "    )" & vbCrLf
'//2006/06/16 ñæç◊çÌèúëŒâû
    Condition = Condition & " AND FIERROR >= " & mYimp.errNormal & vbCrLf
    
    
    '//ÇPÉOÉãÅ[Évì‡Ç≈Ç∑Ç◊Çƒê≥èÌ(FIOKFG=0)Ç≈ñ≥Ç¢Ç∆çXêVÇÕÇµÇ»Ç¢
    sql = "SELECT a.*" & vbCrLf
    sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
    sql = sql & " WHERE 1 = 1" & vbCrLf '//Ç®Ç‹Ç∂Ç»Ç¢
    sql = sql & Condition
    sql = sql & "  AND FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf           '//çáåvÉåÉRÅ[ÉhÇÕïsóv
#If ORA_DEBUG = 1 Then
    Set dyn = gdDBS.OpenRecordset(sql, dynOption.ORADYN_READONLY)
#Else
    Set dyn = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
#End If
    recCnt = dyn.RecordCount
    If dyn.EOF Then
        Call dyn.Close
        Set dyn = Nothing
        Call MsgBox("éÊçûì˙éû [ " & cboImpDate.Text & " ]" & vbCrLf & "Ç…É}ÉXÉ^îΩâfÇ∑Ç◊Ç´ÉfÅ[É^ÇÕÇ†ÇËÇ‹ÇπÇÒÅB", vbOKOnly + vbInformation, mCaption)
        '//É{É^ÉìÇñﬂÇ∑
        cmdUpdate.Caption = cBtnUpdate
        '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
        Call pLockedControl(True)
        Exit Sub
    End If
    fraProgressBar.Visible = True
    pgrProgressBar.Max = recCnt
    Do Until dyn.EOF
        DoEvents
        If mAbort Then
            GoTo cmdUpdate_ClickError
        End If
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = _
            "écÇË" & Right(String(7, " ") & Format(recCnt - dyn.RowPosition, "#,##0"), 7) & " åè"
        pgrProgressBar.Value = dyn.RowPosition
        '///////////////////////////////////////////////
        '//êUë÷ó\íËÉfÅ[É^Ç÷ÇÃçXêV
        '///////////////////////////////////////////////
        sql = "UPDATE tfFurikaeYoteiData SET " & vbCrLf
'frmKouzaFurikaeExport(å˚ç¿êUë÷ÉfÅ[É^çÏê¨) Ç≈ÇÃÉfÅ[É^ÇÕ FASKGK ÇèoóÕÇµÇƒÇ¢ÇÈÅI
        sql = sql & " FASKGK = " & gdDBS.ColumnDataSet(dyn.Fields("FIHKKG"), "L") & vbCrLf
        'sql = sql & " FAHKGK = " & gdDBS.ColumnDataSet(dyn.Fields("FIHKGK"), "L") & vbCrLf
        sql = sql & " FAKYFG = " & gdDBS.ColumnDataSet(dyn.Fields("FIKYFG"), "I") & vbCrLf
        '//2003/02/03 çXêVèÛë‘ÉtÉâÉOí«â¡:0=DBçÏê¨,1=ó\íËçÏê¨,2=ó\íËéÊçû,3=êøãÅçÏê¨
        sql = sql & " FAUPFG = " & gdDBS.ColumnDataSet(eKouFuriKubun.YoteiImport, "I") & vbCrLf
        sql = sql & " FAUSID = " & gdDBS.ColumnDataSet(gcImportUserName) & vbCrLf  '//çXêVé“ÇhÇc
        sql = sql & " FAUPDT = SYSDATE" & vbCrLf
        sql = sql & " WHERE FAITKB = " & gdDBS.ColumnDataSet(dyn.Fields("FIITKB"), vEnd:=True) & vbCrLf
        sql = sql & "   AND FAKYCD = " & gdDBS.ColumnDataSet(dyn.Fields("FIKYCD"), vEnd:=True) & vbCrLf
        sql = sql & "   AND FAKSCD = " & gdDBS.ColumnDataSet(dyn.Fields("FIKSCD"), vEnd:=True) & vbCrLf
        sql = sql & "   AND FAHGCD = " & gdDBS.ColumnDataSet(dyn.Fields("FIHGCD"), vEnd:=True) & vbCrLf
        sql = sql & "   AND FASQNO = " & gdDBS.ColumnDataSet(dyn.Fields("FIFKDT"), vEnd:=True) & vbCrLf
        updCnt = gdDBS.Database.ExecuteSQL(sql)
        '///////////////////////////////////////////////
        '//2003/02/03 ï€åÏé“É}ÉXÉ^Ç÷ÇÃçXêV
        '///////////////////////////////////////////////
        sql = "UPDATE tcHogoshaMaster SET " & vbCrLf
        sql = sql & " CASKGK = " & gdDBS.ColumnDataSet(dyn.Fields("FIHKKG"), "L") & vbCrLf
        sql = sql & " CAKYFG = " & gdDBS.ColumnDataSet(dyn.Fields("FIKYFG"), "I") & vbCrLf
        '//âñÒÇ≥ÇÍÇΩÇÃÇ≈å˚ç¿êUë÷èIóπì˙Çç°ì˙ÇÃì˙ïtÇ≈ñÑÇﬂçûÇﬁ
        If 0 <> Val(gdDBS.Nz(dyn.Fields("FIKYFG"))) Then
            'sql = sql & " CAFKED = TO_CHAR(SYSDATE,'YYYYMMDD')," & vbCrLf
            '//êÊì™Ç≈ê›íËÇµÇƒÇ¢ÇÈÅFÉVÉXÉeÉÄÉ}ÉXÉ^ÇÃéüâÒêUë÷ì˙(ï€åÏé“à∂)ÇÃëOì˙
            sql = sql & " CAFKED = " & gdDBS.ColumnDataSet(CanDate, "I") & vbCrLf
        End If
        sql = sql & " CAUSID = " & gdDBS.ColumnDataSet(gcImportUserName) & vbCrLf  '//çXêVé“ÇhÇc
        sql = sql & " CAUPDT = SYSDATE" & vbCrLf
        sql = sql & " WHERE CAITKB = " & gdDBS.ColumnDataSet(dyn.Fields("FIITKB"), vEnd:=True) & vbCrLf
        sql = sql & "   AND CAKYCD = " & gdDBS.ColumnDataSet(dyn.Fields("FIKYCD"), vEnd:=True) & vbCrLf
        sql = sql & "   AND CAKSCD = " & gdDBS.ColumnDataSet(dyn.Fields("FIKSCD"), vEnd:=True) & vbCrLf
        sql = sql & "   AND CAHGCD = " & gdDBS.ColumnDataSet(dyn.Fields("FIHGCD"), vEnd:=True) & vbCrLf
        sql = sql & "   AND " & gdDBS.ColumnDataSet(dyn.Fields("FIFKDT"), vEnd:=True) & _
                            " BETWEEN CAFKST AND CAFKED " & vbCrLf
        updCnt = gdDBS.Database.ExecuteSQL(sql)
        Call dyn.MoveNext
    Loop
    Call dyn.Close
    Set dyn = Nothing
'//É}ÉXÉ^Å[îΩâfÇÃåèêîè⁄ç◊ÇéÊìæÇ∑ÇÈÅFÉpÉìÉ`ÉfÅ[É^Ç∆ÇÃåèêîÉ`ÉFÉbÉNóp
    Dim total(0 To 2) As Long
    Dim Detail(0 To 2) As Long
    Dim BadCnt(0 To 2) As Long
    '//çáåvçsèÓïÒ
    sql = "SELECT " & vbCrLf
    sql = sql & " SUM(DECODE(NVL(FIOKFG, 0)," & mYimp.updNormal & ",  NVL(FIICNT,0),0)) OK_CNT," & vbCrLf
    sql = sql & " SUM(DECODE(NVL(FIOKFG, 0)," & mYimp.updNormal & ",0,NVL(FIICNT,0)  )) NG_CNT," & vbCrLf
    sql = sql & " SUM(CASE WHEN NVL(FIICNT,0) > 1 THEN (NVL(FIICNT,0) - 1) "
    sql = sql & "          ELSE 0 END) DUPCNT " & vbCrLf
    sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
    sql = sql & " WHERE FIINDT = TO_DATE('" & cboImpDate.Text & "','yyyy/mm/dd hh24:mi:ss') " & vbCrLf
    sql = sql & "   AND FIRKBN = " & mYimp.RecordIsTotal & vbCrLf           '//çáåvÉåÉRÅ[Éh
#If ORA_DEBUG = 1 Then
    Set dyn = gdDBS.OpenRecordset(sql, dynOption.ORADYN_READONLY)
#Else
    Set dyn = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
#End If
    If Not dyn.EOF Then
        total(0) = dyn.Fields("OK_CNT")
        total(1) = dyn.Fields("NG_CNT")
        total(2) = dyn.Fields("DUPCNT")
    End If
    Call dyn.Close
    Set dyn = Nothing
    '//ñæç◊çsÇÃçáåvçsÇ™ê≥èÌï™
    sql = "SELECT" & vbCrLf
    sql = sql & " SUM(DECODE(NVL(FIOKFG, 0)," & mYimp.updNormal & ",  NVL(FIICNT,0),0)) OK_CNT," & vbCrLf
    sql = sql & " SUM(DECODE(NVL(FIOKFG, 0)," & mYimp.updNormal & ",0,NVL(FIICNT,0)  )) NG_CNT," & vbCrLf
    sql = sql & " SUM(CASE WHEN NVL(FIOKFG, 0) = " & mYimp.updNormal & " AND NVL(FIICNT,0) > 1 THEN (NVL(FIICNT,0) - 1) "
    sql = sql & "          ELSE 0 END) DUPCNT   " & vbCrLf
    sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
    sql = sql & " WHERE FIINDT = TO_DATE('" & cboImpDate.Text & "','yyyy/mm/dd hh24:mi:ss') " & vbCrLf
    sql = sql & "   AND FIRKBN IN (" & vbCrLf
    sql = sql & "       SELECT FISEQN" & vbCrLf
    sql = sql & "       FROM " & mYimp.TfFurikaeImport & " b " & vbCrLf
    sql = sql & "       WHERE FIINDT = TO_DATE('" & cboImpDate.Text & "','yyyy/mm/dd hh24:mi:ss') " & vbCrLf
    sql = sql & "         AND FIRKBN = " & mYimp.RecordIsTotal & vbCrLf           '//çáåvÉåÉRÅ[Éh
    sql = sql & "         AND FIOKFG = " & mYimp.updNormal & vbCrLf
    sql = sql & "   )" & vbCrLf
#If ORA_DEBUG = 1 Then
    Set dyn = gdDBS.OpenRecordset(sql, dynOption.ORADYN_READONLY)
#Else
    Set dyn = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
#End If
    If Not dyn.EOF Then
        Detail(0) = dyn.Fields("OK_CNT")
        Detail(1) = dyn.Fields("NG_CNT")
        Detail(2) = dyn.Fields("DUPCNT")
    End If
    Call dyn.Close
    Set dyn = Nothing
    '//ñæç◊çsÇÃçáåvçsÇ™àŸèÌï™
    sql = "SELECT" & vbCrLf
    sql = sql & " SUM(DECODE(NVL(FIOKFG, 0)," & mYimp.updNormal & ",  NVL(FIICNT,0),0)) TT_CNT," & vbCrLf
    sql = sql & " SUM(DECODE(NVL(FIOKFG, 0)," & mYimp.updNormal & ",0,NVL(FIICNT,0)  )) DT_CNT," & vbCrLf
    sql = sql & " SUM(CASE WHEN NVL(FIICNT,0) > 1 THEN (NVL(FIICNT,0) - 1) "
    sql = sql & "          ELSE 0 END) DUPCNT " & vbCrLf
    sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
    sql = sql & " WHERE FIINDT = TO_DATE('" & cboImpDate.Text & "','yyyy/mm/dd hh24:mi:ss') " & vbCrLf
    sql = sql & "   AND FIRKBN IN (" & vbCrLf
    sql = sql & "       SELECT FISEQN" & vbCrLf
    sql = sql & "       FROM " & mYimp.TfFurikaeImport & " b " & vbCrLf
    sql = sql & "       WHERE FIINDT = TO_DATE('" & cboImpDate.Text & "','yyyy/mm/dd hh24:mi:ss') " & vbCrLf
    sql = sql & "         AND FIRKBN = " & mYimp.RecordIsTotal & vbCrLf           '//çáåvÉåÉRÅ[Éh
    sql = sql & "         AND FIOKFG <>" & mYimp.updNormal & vbCrLf
    sql = sql & "   )" & vbCrLf
#If ORA_DEBUG = 1 Then
    Set dyn = gdDBS.OpenRecordset(sql, dynOption.ORADYN_READONLY)
#Else
    Set dyn = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
#End If
    If Not dyn.EOF Then
        BadCnt(0) = gdDBS.Nz(dyn.Fields("TT_CNT"), 0)
        BadCnt(1) = gdDBS.Nz(dyn.Fields("DT_CNT"), 0)
        BadCnt(2) = gdDBS.Nz(dyn.Fields("DUPCNT"), 0)
    End If
    Call dyn.Close
    Set dyn = Nothing
    
    '//É}ÉXÉ^îΩâféûÇ…Ç‡ìØÇ∂éñÇÇ∑ÇÈÇÃÇ≈ã§í âª
    If pMoveTempRecords(Condition, cImportToYotei) < 0 Then
        GoTo cmdUpdate_ClickError:
    End If
    Call gdDBS.Database.CommitTrans
    
    pgrProgressBar.Max = pgrProgressBar.Max
    fraProgressBar.Visible = False
    
    '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
    stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "îΩâfäÆóπ"
    Call MsgBox("É}ÉXÉ^îΩâfëŒè€ = [" & cboImpDate.Text & "]" & vbCrLf & vbCrLf & _
            recCnt & " åèÇ™É}ÉXÉ^îΩâfÇ≥ÇÍÇ‹ÇµÇΩ.(ñæç◊ÅFê≥èÌÅ{ì‡èdï°ÇÃåèêî)" & vbCrLf & vbCrLf & _
            "Å¶îΩâfÇ≥ÇÍÇΩè⁄ç◊ì‡óe" & vbCrLf & _
            "çáåvÅFê≥èÌÅÅ" & total(0) & " (ì‡èdï°ÅF" & total(2) & ")" & "àŸèÌÅÅ" & total(1) & vbCrLf & _
            "ñæç◊ÅFê≥èÌÅÅ" & Detail(0) & " (ì‡èdï°ÅF" & Detail(2) & ")" & "àŸèÌÅÅ" & Detail(1) + BadCnt(0) + BadCnt(1) & vbCrLf & _
            "Å@éÊçûåèêîÅÅ" & Detail(0) + Detail(1) + total(0) + total(1) + BadCnt(0) + BadCnt(1) _
            , vbOKOnly + vbInformation, mCaption)
    Call gdDBS.AutoLogOut(mCaption, "[" & cboImpDate.Text & "] ÇÃ " & recCnt & " åèÇÃîΩâfÇ™äÆóπÇµÇ‹ÇµÇΩÅB(ñæç◊ÅFê≥èÌÅ{ì‡èdï°ÇÃåèêî)" & _
                            "Å@è⁄ç◊åèêîÅÅ" & Detail(0) & " (ì‡èdï°ÅF" & Detail(2) & ")" & _
                            "Å@éÊçûåèêîÅÅ" & Detail(0) + Detail(1) + total(0) + total(1) + BadCnt(0) + BadCnt(1) _
                        )
    
    '//ÉäÉXÉgÇçƒê›íË
    Call pMakeComboBox
    '//É{É^ÉìÇñﬂÇ∑
    cmdUpdate.Caption = cBtnUpdate
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(True)
    Exit Sub
cmdUpdate_ClickError:
    Call gdDBS.Database.Rollback
    If Err Then
        Dim errCode As Integer, errMsg As String
        If gdDBS.Database.LastServerErr Then
            errCode = gdDBS.Database.LastServerErr
            errMsg = gdDBS.Database.LastServerErrText
        Else
            errCode = Err
            errMsg = Error
        End If
        fraProgressBar.Visible = False
        '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "É}ÉXÉ^îΩâfÉGÉâÅ[(" & errCode & ")"
        Call gdDBS.AutoLogOut(mCaption, "ÉGÉâÅ[Ç™î≠ê∂ÇµÇΩÇΩÇﬂÉ}ÉXÉ^îΩâfÇÕíÜé~Ç≥ÇÍÇ‹ÇµÇΩÅB(Error=" & errMsg & ")")
        Call MsgBox("É}ÉXÉ^îΩâfëŒè€ = [" & cboImpDate.Text & "]" & vbCrLf & _
                    "ÇÕÉGÉâÅ[Ç™î≠ê∂ÇµÇΩÇΩÇﬂÉ}ÉXÉ^îΩâfÇÕíÜé~Ç≥ÇÍÇ‹ÇµÇΩÅB" & vbCrLf & errMsg, _
                vbOKOnly + vbCritical, mCaption)
    Else
        stbStatus.Panels.Item(stbStatus.Panels.Count).Text = "É}ÉXÉ^îΩâfíÜíf"
        Call gdDBS.AutoLogOut(mCaption, "[" & cboImpDate.Text & "] ÇÃÉ}ÉXÉ^îΩâfÇÕíÜé~Ç≥ÇÍÇ‹ÇµÇΩÅB")
    End If
    '//É{É^ÉìÇñﬂÇ∑
    cmdUpdate.Caption = cBtnUpdate
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(True)
End Sub

Private Sub Form_Load()
    mCaption = Me.Caption
    cboFIITKB.Visible = False
    Call mForm.Init(Me, gdDBS)
    Call mSprTotal.Init(sprTotal)
    Call mSprDetail.Init(sprDetail)
    mSprTotal.OperationMode = OperationModeNormal    '//ï“èWÇ∑ÇÈÇÃÇ≈ïWèÄÇ…
    mSprDetail.OperationMode = OperationModeNormal    '//ï“èWÇ∑ÇÈÇÃÇ≈ïWèÄÇ…
    lblDetailCount.Caption = ""
    lblDetailKingaku.Caption = ""
    lblDetailCancel.Caption = ""
    
    Dim ix As Long, temp As String
    '///////////////////////////////////////////////////////////////
    '//Spread ÇÃàœëıé“ñºópWORK gdDBS Ç…ä÷êîÇ™Ç†Ç¡ÇΩÇÃÇ≈ó¨óp
    Call gdDBS.SetItakushaComboBox(cboFIITKB)
    For ix = 0 To cboFIITKB.ListCount - 1
        temp = temp & cboFIITKB.List(ix) & vbTab
    Next ix
    Call mSprTotal.ComboBox(eSprTotal.eItakuName, temp)    '//àœëıé“ñºÇÃóÒÇ…ì‡óeÇê›íË
    
    '//SprTotal ÇÃóÒí≤êÆ
    mSprTotal.Locked(eSprTotal.eErrorStts, -1) = True    '//ï“èWÉçÉbÉN
    mSprTotal.Locked(eSprTotal.eKeiyakuName, -1) = True  '//ï“èWÉçÉbÉN
'//2006/04/26 éùçûì˙ÅEâÒêîí«â¡ÇÃóÒÇï“èWÉçÉbÉN
    mSprTotal.Locked(eSprTotal.eMochikomiBi, -1) = True     '//ï“èWÉçÉbÉN
    mSprTotal.Locked(eSprTotal.eImportCnt, -1) = True      '//ï“èWÉçÉbÉN
    With sprTotal
        'Call sprMeisai_LostFocus    '//ToolTip Çê›íË
        If True <> mReg.Debuged Then
            .MaxCols = eSprTotal.eMaxCols
            '//ÉGÉâÅ[óÒÇ‡Ç†ÇÈÇÃÇ≈ï\é¶óÒ(eUseCol)à»ç~ÇÕîÒï\é¶Ç…Ç∑ÇÈ
            For ix = eSprTotal.eUseCols To eSprTotal.eMaxCols
                .ColWidth(ix) = 0
            Next ix
            '//ñæç◊ëSëÃÇÃèCê≥ÉtÉâÉOÉäÉZÉbÉg
        End If
        .Tag = mSprTotal.RowNonEdit
    End With
    '//SprDetail ÇÃóÒí≤êÆ
    mSprDetail.Locked(eSprDetail.eErrorStts, -1) = True '//ï“èWÉçÉbÉN
    mSprDetail.Locked(eSprDetail.eMasterKouza, -1) = True  '//ï“èWÉçÉbÉN
'//2006/04/27 ì¸óÕçÄñ⁄
'//    mSprDetail.Locked(eSprDetail.eImportKouza, -1) = True  '//ï“èWÉçÉbÉN
'//2006/04/26 éùçûì˙ÅEâÒêîí«â¡ÇÃóÒÇï“èWÉçÉbÉN
    mSprDetail.Locked(eSprDetail.eMochikomiBi, -1) = True     '//ï“èWÉçÉbÉN
    mSprDetail.Locked(eSprDetail.eImportCnt, -1) = True      '//ï“èWÉçÉbÉN
    With sprDetail
        '//èâä˙ï\é¶ÇÕÇOåèÅAçáåvÉNÉäÉbÉNéûÇ…ï\é¶Ç≥ÇÍÇÈÇÊÇ§Ç…...ÅB
        dbcImportDetail.RecordSource = ""
        .MaxRows = 0
        If True <> mReg.Debuged Then
            'Call sprMeisai_LostFocus    '//ToolTip Çê›íË
            .MaxCols = eSprDetail.eMaxCols
            '//ÉGÉâÅ[óÒÇ‡Ç†ÇÈÇÃÇ≈ï\é¶óÒ(eUseCol)à»ç~ÇÕîÒï\é¶Ç…Ç∑ÇÈ
            For ix = eSprDetail.eUseCols To eSprDetail.eMaxCols
                .ColWidth(ix) = 0
            Next ix
        End If
        '//ñæç◊ëSëÃÇÃèCê≥ÉtÉâÉOÉäÉZÉbÉg
        .Tag = mSprDetail.RowNonEdit
    End With
    '//ÉXÉeÅ[É^ÉXçsÇÃêÆóÒÅEí≤êÆ
    stbStatus.Panels.Item(stbStatus.Panels.Count).Text = ""
    pgrProgressBar.Left = 15
    pgrProgressBar.Top = 15
    pgrProgressBar.Height = 255
    pgrProgressBar.Width = 7035
    fraProgressBar.Height = pgrProgressBar.Height + 30
    fraProgressBar.Width = pgrProgressBar.Width + 30
    fraProgressBar.Visible = False
    cboSort.ListIndex = 0
    Call fraProgressBar.ZOrder(0)   '//ç≈ëOñ Ç…
    Call pMakeComboBox
'    txtFurikaebi.Text = mReg.FurikaeDataImport
End Sub

Private Sub Form_Resize()
    '//Ç±ÇÍà»è„è¨Ç≥Ç≠Ç∑ÇÈÇ∆ÉRÉìÉgÉçÅ[ÉãÇ™âBÇÍÇÈÇÃÇ≈êßå‰Ç∑ÇÈ
    If Me.Height < 8100 Then
        Me.Height = 8100
    End If
    If Me.Width < 11300 Then
        Me.Width = 11300
    End If
    Call mForm.Resize
    fraProgressBar.Left = 1860
    fraProgressBar.Top = Me.Height - 970
End Sub

Private Sub Form_Unload(Cancel As Integer)
    mAbort = True
    Set mForm = Nothing
    Set mReg = Nothing
    Set frmFurikaeYoteiImport = Nothing
    Call gdForm.Show
End Sub

Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)
    If UnloadMode = vbFormControlMenu Then
        Cancel = True
    End If
End Sub

Private Sub mnuEnd_Click()
    Call cmdEnd_Click
End Sub

Private Sub mnuVersion_Click()
    Call frmAbout.Show(vbModal)
End Sub

'//ÅuçáåvÉfÅ[É^ÅvÉZÉãíPà Ç…ÉGÉâÅ[â”èäÇÉJÉâÅ[ï\é¶
Private Sub pSpreadTotalSetErrorStatus(Optional vReset As Boolean = False)
#If ORA_DEBUG = 1 Then
    Dim sql As String, dyn As OraDynaset
#Else
    Dim sql As String, dyn As Object
#End If
    Dim ErrStts() As Variant, ix As Integer, cnt As Long
    Dim ms As New MouseClass
    Call ms.Start
'    eErrorStts = 1  '   FIERROR ÉGÉâÅ[ì‡óeÅFàŸèÌÅAê≥èÌÅAåxçê
'    eItakuName      '           àœëıé“ñº
'    eKeiyakuCode    '   FIKYCD  å_ñÒé“
'    eKeiyakuName    '           å_ñÒé“ñº
'    eKyoshitsuNo    '   FIKSCD  ã≥é∫î‘çÜ
'    ePageNumber     '   FIPGNO  ï≈
'    eFirukaeDate    '   FIFKDT  êUë÷ì˙
'    eHenkoCount     '   FIHKCT  ïœçXåèêî
'    eHenkoKingaku   '   FIHKCT  ïœçXã‡äz
'    eCancelCount    '   FIKYCT  âñÒåèêî
    
    If sprTotal.MaxRows = 0 Then
        Exit Sub
    End If
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(False)
    '//ÉGÉâÅ[óÒÇê›íË
    ErrStts = Array("FIERROr", Empty, Empty, "FIITKBe", "FIKYCDe", "fikycde", "FIKSCDe", "FIPGNOe", "FIFKDTe", _
                    "FIHKCTe", "FIHKKGe", "FIKYCTe" _
                )
    sql = "SELECT ROWNUM,a.* FROM(" & vbCrLf
    sql = sql & "SELECT FIINDT,FISEQN," & mYimp.StatusColumns("," & vbCrLf, Len("," & vbCrLf))
    sql = sql & " FROM " & mYimp.TfFurikaeImport & " a " & vbCrLf
    sql = sql & " WHERE FIINDT = TO_DATE('" & cboImpDate.Text & "','yyyy/mm/dd hh24:mi:ss') " & vbCrLf
    sql = sql & "   AND FIRKBN = " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & " ORDER BY " & cSQLOrderString & vbCrLf
    '//à»ç~ÇÃÇnÇqÇcÇdÇqãÂ
    Select Case cboSort.ListIndex
    Case eSort.eImportSeq
        sql = sql & ",FIINDT,FISEQN" & vbCrLf
    Case eSort.eKeiyakusha
        sql = sql & ",FIITKB,FIKYCD,FIKSCD,FIPGNO,FIFKDT,FIHGCD,FISEQN" & vbCrLf
    Case Else
    End Select
    sql = sql & ") a"
#If ORA_DEBUG = 1 Then
    Set dyn = gdDBS.OpenRecordset(sql, dynOption.ORADYN_READONLY)
#Else
    Set dyn = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
#End If
    If False = vReset Then
        'SPread ÇÃÉXÉNÉçÅ[ÉãÉoÅ[âüâ∫éûÇÃÇ›äJénçsÇ…à⁄ìÆ
        Call dyn.FindFirst("ROWNUM >= " & sprTotal.TopRow)
    End If
    mSprTotal.Redraw = False
    cnt = 0
    Do Until dyn.EOF
        '//èàóùÇ™ï°éGÇ…Ç»ÇÈÇÃÇ≈Ç∆Ç…Ç©Ç≠ÇQÇTçsÇÕì«ÇÒÇ≈ÇµÇ‹Ç¶ÅI
        'If 0 = dyn.Fields(ErrStts(0)) And "ê≥èÌ" = mSpread.Value(eSprCol.eErrorStts, dyn.RowPosition) Then
        '    Exit Do     '//àŸèÌÅAåxçêÅAê≥èÌÇÃÉfÅ[É^èáÇ…ï¿ÇÒÇ≈Ç¢ÇÈÇÕÇ∏Ç»ÇÃÇ≈ê≥èÌÉfÅ[É^Ç™óàÇΩÇ»ÇÁèIóπÇµÇƒÇ‡â¬ÅI
        'End If
        cnt = cnt + 1
        If cnt > cVisibleRows Then    '//âºëzÉÇÅ[ÉhÇ»ÇÃÇ≈ÇQÇTçsê›íËÇµÇΩéûì_Ç≈èIóπ
            Exit Do
        End If
        For ix = LBound(ErrStts) To UBound(ErrStts)
            '//äeóÒÇÃï\é¶êFïœçX
            If Not IsEmpty(ErrStts(ix)) Then
                mSprTotal.BackColor(ix + 1, dyn.RowPosition) = mYimp.ErrorStatus(dyn.Fields(ErrStts(ix)))
            End If
        Next ix
        '//èàóùåãâ óÒÇÃï\é¶êF
        If mYimp.ErrorStatus(mYimp.errNormal) = mSprTotal.BackColor(eSprTotal.eErrorStts, dyn.RowPosition) Then
            mSprTotal.BackColor(eSprTotal.eErrorStts, dyn.RowPosition) = vbCyan
        End If
        Call dyn.MoveNext
    Loop
    Call dyn.Close
    Set dyn = Nothing
    mSprTotal.Redraw = True
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(True)
End Sub

'//Åuñæç◊ÉfÅ[É^ÅvÉZÉãíPà Ç…ÉGÉâÅ[â”èäÇÉJÉâÅ[ï\é¶
Private Sub pSpreadDetailSetErrorStatus(vImpDate As String, vSeqNo As Long, Optional vReset As Boolean = False)
#If ORA_DEBUG = 1 Then
    Dim sql As String, dyn As OraDynaset
#Else
    Dim sql As String, dyn As Object
#End If
    Dim ErrStts() As Variant, ix As Integer, cnt As Long
    Dim ms As New MouseClass
    Call ms.Start
'    eErrorStts = 1  '   FIERROR ÉGÉâÅ[ì‡óeÅFàŸèÌÅAê≥èÌÅAåxçê
'    eHogoshaNo      '   FIHGCD  ï€åÏé“î‘çÜ
'    eMasterKouza
'    eImportKouza
'    eHenkoGaku      '   FIHKKG  ïœçXã‡äz
'    eCancelFlag     '   FIKYFG  âñÒÉtÉâÉO
    
    If sprDetail.MaxRows = 0 Then
        Exit Sub
    End If
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(False)
    '//ÉGÉâÅ[óÒÇê›íË
    ErrStts = Array("FIERROr", Empty, Empty, "FIHGCDe", "FIKZNMe", "fikznme", "FIHKKGe", "FIKYFGe" _
                )
    sql = "SELECT ROWNUM,a.* FROM(" & vbCrLf
    sql = sql & "SELECT TO_CHAR(FIINDT,'yyyy/mm/dd hh24:mi:ss') FIINDT,FISEQN," & mYimp.StatusColumns("," & vbCrLf, Len("," & vbCrLf))
    sql = sql & " FROM " & mYimp.TfFurikaeImport & " a "
    sql = sql & " WHERE (" & cInSQLString & ") IN(" & vbCrLf
    sql = sql & "       SELECT " & cInSQLString & vbCrLf
    sql = sql & "       FROM " & mYimp.TfFurikaeImport & " b " & vbCrLf
    sql = sql & "       WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(cboImpDate.Text, vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss')" & vbCrLf
    sql = sql & "         AND FISEQN = " & vSeqNo & vbCrLf
    sql = sql & "         AND FIRKBN = " & mYimp.RecordIsTotal & vbCrLf
    sql = sql & "       )"
    sql = sql & "   AND FIRKBN <> " & mYimp.RecordIsTotal & vbCrLf
'//ñæç◊ÇÕÇrÇdÇpèáÇ…
#If DETAIL_SEQN_ORDER = True Then
    sql = sql & " ORDER BY FIINDT,FISEQN" & vbCrLf
#Else
    sql = sql & " ORDER BY " & cSQLOrderString & vbCrLf
    '//à»ç~ÇÃÇnÇqÇcÇdÇqãÂ
    Select Case cboSort.ListIndex
    Case eSort.eImportSeq
        sql = sql & ",FIINDT,FISEQN" & vbCrLf
    Case eSort.eKeiyakusha
        sql = sql & ",FIITKB,FIKYCD,FIKSCD,FIPGNO,FIFKDT,FIHGCD,FISEQN" & vbCrLf
    Case Else
    End Select
#End If
    sql = sql & ") a"
#If ORA_DEBUG = 1 Then
    Set dyn = gdDBS.OpenRecordset(sql, dynOption.ORADYN_READONLY)
#Else
    Set dyn = gdDBS.OpenRecordset(sql, OracleConstantModule.ORADYN_READONLY)
#End If
    If False = vReset Then
        'SPread ÇÃÉXÉNÉçÅ[ÉãÉoÅ[âüâ∫éûÇÃÇ›äJénçsÇ…à⁄ìÆ
        Call dyn.FindFirst("ROWNUM >= " & sprDetail.TopRow)
    End If
    mSprDetail.Redraw = False
    cnt = 0
    Do Until dyn.EOF
        '//èàóùÇ™ï°éGÇ…Ç»ÇÈÇÃÇ≈Ç∆Ç…Ç©Ç≠ÇQÇTçsÇÕì«ÇÒÇ≈ÇµÇ‹Ç¶ÅI
        'If 0 = dyn.Fields(ErrStts(0)) And "ê≥èÌ" = mSpread.Value(eSprCol.eErrorStts, dyn.RowPosition) Then
        '    Exit Do     '//àŸèÌÅAåxçêÅAê≥èÌÇÃÉfÅ[É^èáÇ…ï¿ÇÒÇ≈Ç¢ÇÈÇÕÇ∏Ç»ÇÃÇ≈ê≥èÌÉfÅ[É^Ç™óàÇΩÇ»ÇÁèIóπÇµÇƒÇ‡â¬ÅI
        'End If
        cnt = cnt + 1
        If cnt > cVisibleRows Then    '//âºëzÉÇÅ[ÉhÇ»ÇÃÇ≈ÇQÇTçsê›íËÇµÇΩéûì_Ç≈èIóπ
            Exit Do
        End If
        For ix = LBound(ErrStts) To UBound(ErrStts)
            '//äeóÒÇÃï\é¶êFïœçX
            If Not IsEmpty(ErrStts(ix)) Then
                mSprDetail.BackColor(ix + 1, dyn.RowPosition) = mYimp.ErrorStatus(dyn.Fields(ErrStts(ix)))
            End If
        Next ix
        '//èàóùåãâ óÒÇÃï\é¶êF
        If mYimp.ErrorStatus(mYimp.errNormal) = mSprDetail.BackColor(eSprDetail.eErrorStts, dyn.RowPosition) Then
            mSprDetail.BackColor(eSprDetail.eErrorStts, dyn.RowPosition) = vbCyan
        End If
        Call dyn.MoveNext
    Loop
    Call dyn.Close
    Set dyn = Nothing
    mSprDetail.Redraw = True
    '//ÉRÉ}ÉìÉhÅEÉ{É^Éìêßå‰
    Call pLockedControl(True)
End Sub

Private Sub sprDetail_Change(ByVal Col As Long, ByVal Row As Long)
    '//çXêVîªífópÇ…èCê≥ÉtÉâÉOê›íË
    mSprDetail.Value(eSprDetail.eEditFlag, Row) = mSprDetail.RowEdit
    '//ñæç◊çsÇ…ï∂åæÇê›íË
    mSprDetail.Value(eSprDetail.eErrorStts, Row) = cEditDataMsg
    '//ñæç◊çsÇÃï∂åæÇêFê›íË
    mSprDetail.BackColor(eSprDetail.eErrorStts, Row) = mYimp.ErrorStatus(mYimp.errEditData)
    '//ñæç◊çsÇ…èCê≥ÉtÉâÉOê›íË
    mSprDetail.Value(eSprDetail.eErrorFlag, Row) = mYimp.errEditData
    '//Tag Ç…èCê≥ÇµÇΩÅIÇÉ}Å[ÉLÉìÉO
    sprDetail.Tag = mSprDetail.RowEdit
    cmdSprUpdate.Enabled = True
End Sub

Private Sub sprDetail_Click(ByVal Col As Long, ByVal Row As Long)
    '//âñÒÉtÉâÉOÇÃÉ`ÉFÉbÉNÉ{É^Éìâüâ∫ => sprDetail_ButtonClicked() Ç≈Ç∑ÇÈÇ∆ñæç◊Çï\é¶Ç∑ÇÈÇΩÇ—Ç…ñàâÒî≠ê∂Ç∑ÇÈÇÃÇ≈ë ñ⁄ÅI
    Select Case Col
    Case eSprDetail.eCancelFlag
        Call sprDetail_Change(Col, Row)
    End Select
End Sub

Private Sub sprDetail_TopLeftChange(ByVal OldLeft As Long, ByVal OldTop As Long, ByVal NewLeft As Long, ByVal NewTop As Long)
    '// OldTop = 1 ÇÃéûÇÕÉCÉxÉìÉgÇ™ãNÇ´Ç»Ç¢
#If True = VIRTUAL_MODE Then
    Call pSpreadDetailSetErrorStatus(cboImpDate.Text, mSprTotal.Value(eSprTotal.eImpSEQ, sprTotal.ActiveRow))
#Else
    If OldTop <> NewTop Then     '//Ç∑Ç◊ÇƒÉoÉbÉtÉ@Ç…Ç†ÇÈÇÃÇ≈ëOçsÇ…ñﬂÇÈéûÇÕÇµÇ»Ç¢ÇÊÇ§Ç…
        Call pSpreadDetailSetErrorStatus(cboImpDate.Text, mSprTotal.Value(eSprTotal.eImpSEQ, sprTotal.ActiveRow))
    End If
#End If
End Sub

Private Sub sprTotal_Change(ByVal Col As Long, ByVal Row As Long)
    If Col <= eSprTotal.eFirukaeDate Then
        '//ÉLÅ[èÓïÒÇèCê≥ÇµÇΩèÍçá
        mSprTotal.Value(eSprTotal.eEditFlag, Row) = mSprTotal.RowEditHeader
    
    ElseIf Val(mSprTotal.Value(eSprTotal.eEditFlag, Row)) <> mSprTotal.RowEditHeader Then
        '//ëOâÒÉLÅ[èÓïÒÇèCê≥ÇµÇƒÇ¢Ç»Ç¢éûÇÃÇ›Ç≈ÅAÉLÅ[èÓïÒà»äOÇèCê≥ÇµÇΩèÍçá
        mSprTotal.Value(eSprTotal.eEditFlag, Row) = mSprTotal.RowEdit
    End If
    '//Tag Ç…èCê≥ÇµÇΩÅIÇÉ}Å[ÉLÉìÉO
    sprTotal.Tag = mSprTotal.RowEdit
    '//ñæç◊çsÇ…ï∂åæÇê›íË
    mSprTotal.Value(eSprTotal.eErrorStts, Row) = cEditDataMsg
    '//ñæç◊çsÇÃï∂åæÇêFê›íË
    mSprTotal.BackColor(eSprTotal.eErrorStts, Row) = mYimp.ErrorStatus(mYimp.errEditData)
    '//ñæç◊çsÇ…èCê≥ÉtÉâÉOê›íË
    mSprTotal.Value(eSprTotal.eErrorFlag, Row) = mYimp.errEditData
    cmdSprUpdate.Enabled = True
End Sub

Private Function pSpreadCheckAndUpdate(vMode As Boolean) As Boolean
    'If sprTotal.Tag = mSprTotal.RowEdit Or sprDetail.Tag = mSprDetail.RowEdit Then
    If True = vMode Then
        Select Case MsgBox("ì‡óeÇ™ïœçXÇ≥ÇÍÇƒÇ¢Ç‹Ç∑ÅB" & vbCrLf & vbCrLf & _
                           "çXêVÇµÇ‹Ç∑Ç©ÅH", vbYesNoCancel + vbInformation, mCaption)
        Case vbYes
            Call cmdSprUpdate_Click
        Case vbNo
            '//ïœçXì‡óeÇîjä¸
            '//çáåvÅïñæç◊ÇÃèCê≥ÉtÉâÉOÇÉäÉZÉbÉg
            sprDetail.Tag = mSprDetail.RowNonEdit
            sprTotal.Tag = mSprTotal.RowNonEdit
            Call cboImpDate_Click
        Case vbCancel
            pSpreadCheckAndUpdate = True '// LeaveCell() ÇÉLÉÉÉìÉZÉã
            Exit Function
        End Select
    End If
    'cmdSprUpdate.Enabled = False
End Function

'//2006/06/16 çáåvçsÇòAë±Ç≈èCê≥éûÇ…çXêVÉ{É^ÉìÇ™ Enabled=False Ç…Ç»ÇÈà◊ÅAçXêVÉ{É^ÉìèÛë‘Çí«â¡
Private Function pSpreadDetailChange(Optional ByVal Row As Long = -1, Optional vButton As Boolean = False) As Boolean
    If True = pSpreadCheckAndUpdate(vButton Or sprDetail.Tag = mSprDetail.RowEdit) Then
        pSpreadDetailChange = True  '// LeaveCell() ÇÉLÉÉÉìÉZÉã
        Exit Function
    End If
    If Row <= 0 Then
        '//ÉRÉ}ÉìÉhÉ{É^Éìâüâ∫éûÇ… Row = -1 Ç∆Ç»ÇÈ
        Exit Function
    End If
    Dim ms As New MouseClass
    Call ms.Start
    '//ÉfÅ[É^ì«Ç›çûÇ›Åï Spread Ç…ê›íËîΩâf
    Call pReadDetailDataAndSetting(mSprTotal.Value(eSprTotal.eImpDate, Row), mSprTotal.Value(eSprTotal.eImpSEQ, Row))
    cmdSprUpdate.Enabled = False
    sprDetail.Tag = mSprDetail.RowNonEdit
    '// LeaveCell() ÉCÉxÉìÉgÇ… Cancel ÉtÉâÉOÇï‘ãp
    pSpreadDetailChange = False
End Function

Private Sub sprTotal_Click(ByVal Col As Long, ByVal Row As Long)
    '//ãNìÆéûÇÃÇPâÒñ⁄ÇÃÇ› LeaveCell ÉCÉxÉìÉgÇ™î≠ê∂ÇµÇ»Ç¢ÇÃÇ≈êßå‰
    If False = mLeaveCellEvents And Row > 0 Then
        Call pSpreadDetailChange(Row, cmdSprUpdate.Enabled)
    End If
End Sub

Private Sub sprTotal_ComboCloseUp(ByVal Col As Long, ByVal Row As Long, ByVal SelChange As Integer)
    '//âBÇµÉRÉìÉ{É{ÉbÉNÉXÇégópÇµÇƒã≠êßìIÇ…ÉRÅ[ÉhéÊìæ
    '//2006/06/13 å_ñÒé“áÇñ≥ÇµÇÃéûÇÃàœëıé“ñ¢ëIëéûÇ…ÉGÉâÅ[Ç…Ç»ÇÈà◊êßå‰
    If "" <> Trim(mSprTotal.Text(eSprTotal.eItakuName, Row)) Then
        cboFIITKB.Text = mSprTotal.Text(eSprTotal.eItakuName, Row)
    End If
'// 'Z' Ç™ë∂ç›Ç∑ÇÈÇÊÇ§Ç…Ç»Ç¡ÇΩÇÃÇ≈ Val() Çâèú
'    If Val(mSprTotal.Value(eSprTotal.eItakuCode, Row)) <> cboFIITKB.ItemData(cboFIITKB.ListIndex) Then
    If mSprTotal.Value(eSprTotal.eItakuCode, Row) <> cboFIITKB.ItemData(cboFIITKB.ListIndex) Then
        mSprTotal.Value(eSprTotal.eItakuCode, Row) = cboFIITKB.ItemData(cboFIITKB.ListIndex)
    End If
End Sub

Private Sub sprTotal_LeaveCell(ByVal Col As Long, ByVal Row As Long, ByVal NewCol As Long, ByVal NewRow As Long, Cancel As Boolean)
    If Row <> NewRow And NewRow > 0 Then
        Cancel = pSpreadDetailChange(NewRow, cmdSprUpdate.Enabled)
        '//ãNìÆéûÇÃÇPâÒñ⁄ÇÃÇ› LeaveCell ÉCÉxÉìÉgÇ™î≠ê∂ÇµÇ»Ç¢ÇÃÇ≈êßå‰
        mLeaveCellEvents = True
    End If
End Sub

Private Sub pSpreadRightClick(vRow As Long, vHeader As Boolean)
    mnuTitle.Caption = "ÅyëŒè€ÅÅ"
    If True = vHeader Then
        '//çÌèúëŒè€ÇÃÇrÇdÇpÅFÉwÉbÉ_éûÇÕñæç◊Ç‡ìØéûÇ…çÌèú
        mDeleteSeqNo = mSprTotal.Value(eSprTotal.eImpSEQ, vRow)
        mnuTitle.Caption = mnuTitle.Caption & mSprTotal.Text(eSprTotal.eKeiyakuCode, vRow) & "-" & _
                                              mSprTotal.Text(eSprTotal.eKyoshitsuNo, vRow) & "-" & _
                                              mSprTotal.Text(eSprTotal.ePageNumber, vRow)
        mnuSprDelete.Caption = "çáåvçsÇ∆"
        mnuSprReset.Caption = "çáåvçsÇ∆"
        mnuSprDelete.Enabled = mSprTotal.Value(eSprTotal.eErrorFlag, vRow) <> mYimp.errDeleted
        mnuSprReset.Enabled = Not mnuSprDelete.Enabled
    Else
        '//çÌèúëŒè€ÇÃÇrÇdÇpÅFÉwÉbÉ_éûÇÕñæç◊Ç‡ìØéûÇ…çÌèú
        mDeleteSeqNo = mSprTotal.Value(eSprDetail.eImpSEQ, vRow)
        mnuTitle.Caption = mnuTitle.Caption & mSprDetail.Text(eSprDetail.eKeiyakuCode, vRow) & "-" & _
                                              mSprDetail.Text(eSprDetail.eKyoshitsuNo, vRow) & "-" & _
                                              mSprDetail.Text(eSprDetail.ePageNumber, vRow) & "-" & _
                                              mSprDetail.Text(eSprDetail.eHogoshaNo, vRow)
        mnuSprDelete.Caption = ""
        mnuSprReset.Caption = ""
        mnuSprDelete.Enabled = mSprTotal.Value(eSprDetail.eErrorFlag, vRow) <> mYimp.errDeleted
        mnuSprReset.Enabled = Not mnuSprDelete.Enabled
    End If
    mnuTitle.Caption = mnuTitle.Caption & "Åz"
    mnuSprDelete.Caption = mnuSprDelete.Caption & "ñæç◊çsÇçÌèú(&D)"
    mnuSprReset.Caption = mnuSprReset.Caption & "ñæç◊çsÇÃçÌèúÇâèú(&R)"
    mDeleteMenu = ePopup.eNoMenu '//çÌèúÉAÉNÉVÉáÉìÇÃÉÅÉjÉÖÅ[ -1=Delete,0=NonMenu,1=Reset
    Call PopupMenu(mnuSpread)
    Select Case mDeleteMenu
    Case ePopup.eNoMenu
    Case ePopup.eDelete
        If vHeader = True Then
            mSprTotal.Text(eSprTotal.eErrorStts, vRow) = cDeleteMsg
            mSprTotal.BackColor(eSprTotal.eErrorStts, vRow) = mYimp.ErrorStatus(mYimp.errDeleted)
        Else
            mSprDetail.Text(eSprDetail.eErrorStts, vRow) = cDeleteMsg
            mSprDetail.BackColor(eSprDetail.eErrorStts, vRow) = mYimp.ErrorStatus(mYimp.errDeleted)
        End If
    Case ePopup.eReset
        If vHeader = True Then
            mSprTotal.Text(eSprTotal.eErrorStts, vRow) = cEditDataMsg
            mSprTotal.BackColor(eSprTotal.eErrorStts, vRow) = mYimp.ErrorStatus(mYimp.errEditData)
        Else
            mSprDetail.Text(eSprDetail.eErrorStts, vRow) = cEditDataMsg
            mSprDetail.BackColor(eSprDetail.eErrorStts, vRow) = mYimp.ErrorStatus(mYimp.errEditData)
        End If
    End Select
End Sub

Private Sub mnuSprReset_Click()
    Dim sql As String, recCnt As Long
    sql = "UPDATE " & mYimp.TfFurikaeImport & " SET " & vbCrLf
    '//èCê≥èÛë‘Ç…
    sql = sql & " FIERROR = " & mYimp.errEditData & vbCrLf
    sql = sql & " WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(cboImpDate.Text, vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss') " & vbCrLf
    sql = sql & "   AND(FIRKBN = " & gdDBS.ColumnDataSet(mDeleteSeqNo, "L", vEnd:=True) & vbCrLf
    sql = sql & "    OR FISEQN = " & gdDBS.ColumnDataSet(mDeleteSeqNo, "L", vEnd:=True) & vbCrLf
    sql = sql & "     )"
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    If recCnt Then
        mDeleteMenu = ePopup.eReset
    End If
End Sub

Private Sub mnuSprDelete_Click()
    Dim sql As String, recCnt As Long
    sql = "UPDATE " & mYimp.TfFurikaeImport & " SET " & vbCrLf
    sql = sql & " FIERROR = " & mYimp.errDeleted & "," & vbCrLf
'//É}ÉXÉ^îΩâfëŒè€äOÇ…Ç∑ÇÈ
    sql = sql & " FIOKFG  = " & mYimp.updInvalid & vbCrLf
    sql = sql & " WHERE FIINDT = TO_DATE(" & gdDBS.ColumnDataSet(cboImpDate.Text, vEnd:=True) & ",'yyyy/mm/dd hh24:mi:ss') " & vbCrLf
    sql = sql & "   AND(FIRKBN = " & gdDBS.ColumnDataSet(mDeleteSeqNo, "L", vEnd:=True) & vbCrLf
    sql = sql & "    OR FISEQN = " & gdDBS.ColumnDataSet(mDeleteSeqNo, "L", vEnd:=True) & vbCrLf
    sql = sql & "     )"
    recCnt = gdDBS.Database.ExecuteSQL(sql)
    If recCnt Then
        mDeleteMenu = ePopup.eDelete
    End If
End Sub

Private Sub sprDetail_RightClick(ByVal ClickType As Integer, ByVal Col As Long, ByVal Row As Long, ByVal MouseX As Long, ByVal MouseY As Long)
    If sprDetail.SelBlockRow = Row Then
        Call pSpreadRightClick(Row, False)
    End If
End Sub

Private Sub sprTotal_RightClick(ByVal ClickType As Integer, ByVal Col As Long, ByVal Row As Long, ByVal MouseX As Long, ByVal MouseY As Long)
    If sprTotal.SelBlockRow = Row Then
        Call pSpreadRightClick(Row, True)
    End If
End Sub

Private Sub sprTotal_TopLeftChange(ByVal OldLeft As Long, ByVal OldTop As Long, ByVal NewLeft As Long, ByVal NewTop As Long)
    '// OldTop = 1 ÇÃéûÇÕÉCÉxÉìÉgÇ™ãNÇ´Ç»Ç¢
#If True = VIRTUAL_MODE Then
    Call pSpreadTotalSetErrorStatus
#Else
    If OldTop <> NewTop Then     '//Ç∑Ç◊ÇƒÉoÉbÉtÉ@Ç…Ç†ÇÈÇÃÇ≈ëOçsÇ…ñﬂÇÈéûÇÕÇµÇ»Ç¢ÇÊÇ§Ç…
        Call pSpreadTotalSetErrorStatus
    End If
#End If
End Sub
#End If ' NO_RELEASE
